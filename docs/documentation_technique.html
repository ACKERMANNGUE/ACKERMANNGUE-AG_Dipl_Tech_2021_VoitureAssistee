<!DOCTYPE html><html><head>
      <title>Documentation technique de Voiture Assist&#xE9;e</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\admin\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.5.18\node_modules\@shd101wyy\mume\dependencies\katex\katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h1 class="mume-header" id="r%C3%A9sum%C3%A9">R&#xE9;sum&#xE9;</h1>

<p><em>Voiture assist&#xE9;e</em> est un projet d&apos;&#xE9;tude portant sur les voitures autonomes et leur fonctionnement. Ce projet m&apos;a &#xE9;t&#xE9; propos&#xE9; par M. Bonvin &#xE9;tant donn&#xE9; que la premi&#xE8;re &#xE9;bauche du cahier des charges comportait en une simulation de voiture autonome, mais ce dans une application windows form. M. Bonvin ayant entendu parler de mon projet, il a su amener un c&#xF4;t&#xE9; plus int&#xE9;ressant et professionnel dans le travail que je vais devoir r&#xE9;aliser. &#xC9;tant donn&#xE9; la d&#xE9;couverte des diff&#xE9;rents appareils utilis&#xE9;s pour ce projet, la plus-value sera surtout l&apos;acquisition de nouvelles connaissances dans le domaine de l&apos;informatique physique. Par cons&#xE9;quent, le but du projet est de r&#xE9;aliser une voiture se d&#xE9;pla&#xE7;ant &#xE0; l&apos;aide d&apos;une interface web et qui sait se d&#xE9;placer par elle-m&#xEA;me en &#xE9;vitant les obstacles sur sa route.</p>
<h1 class="mume-header" id="abstract">Abstract</h1>

<p><em>Voiture assist&#xE9;e</em> is a study project about autonomous cars and their functioning. This project was proposed to me by Mr. Bonvin since the first draft of the specifications included a simulation of an autonomous car but in a windows form application. Mr. Bonvin heard about my project, he knew how to bring a more interesting and professional side in the work that I will have to realize. Considering the discovery of the different devices used for this project, the added value will be especially the acquisition of new knowledge in the field of physical computing. Therefore, the goal of the project is to realize a car that can be moved by a web interface and that knows how to move by itself and which avoids obstacles on its way.</p>
<h1 class="mume-header" id="poster">Poster</h1>

<p><img src="./images/references_poster/ag_poster_voiture-assistee.png" alt="Poster du projet Voiture Assist&#xE9;e" title="Poster du projet Voiture Assist&#xE9;e"></p>
<h1 class="mume-header" id="cahier-des-charges">Cahier des charges</h1>

<h2 class="mume-header" id="titre-du-projet">Titre du projet</h2>

<p>Le titre du projet est Voiture assist&#xE9;e, car le but du projet est d&apos;en r&#xE9;aliser une.</p>
<h2 class="mume-header" id="contexte">Contexte</h2>

<p>Ce projet m&apos;a &#xE9;t&#xE9; propos&#xE9; par M. Bonvin car il a vu que j&apos;allais faire une simulation de voiture autonome, il s&apos;est dit que l&apos;on pourrait tourner la chose autrement. Il a une multitude de Raspberry Pi, de composants ainsi qu&apos;une voiture LEGO controlable. C&apos;est pourquoi il m&apos;a dirig&#xE9; vers une programmation utilisant des capteurs et du bluetooth.</p>
<h2 class="mume-header" id="objectif">Objectif</h2>

<p>L&apos;objectif principal de ce projet est de r&#xE9;aliser une voiture capable de se d&#xE9;placer d&apos;un point A &#xE0; un point B en &#xE9;vitant les diff&#xE9;rents obstacles sur sa route. Pour ce faire, il faudra trouver un moyen de communiquer avec le Technic Hub afin de mouvoir la voiture. Ensuite, il faudra faire fonctionner ind&#xE9;pendamment les diff&#xE9;rents capteurs. Pour ensuite cr&#xE9;er un algorithme &#xE9;v&#xE9;nementiel g&#xE9;rant les diff&#xE9;rentes pond&#xE9;rations des messages que les capteurs enverront.</p>
<h2 class="mume-header" id="technologies-et-mat%C3%A9riels-utilis%C3%A9s">Technologies et mat&#xE9;riels utilis&#xE9;s</h2>

<h3 class="mume-header" id="logiciels">Logiciels</h3>

<ul>
<li>Visual Studio Code
<ul>
<li>Python</li>
<li>Flask</li>
</ul>
</li>
<li>Github</li>
<li>Markdown</li>
<li>QCAD</li>
<li>Photoshop CS6</li>
<li>Pencil</li>
<li>Trello</li>
</ul>
<h3 class="mume-header" id="mat%C3%A9riels">Mat&#xE9;riels</h3>

<ul>
<li>Raspberry Pi 0 WiFi</li>
<li>Raspberry Pi 4B</li>
<li>2 Cam&#xE9;ra infrarouges (PI NoIR)</li>
<li>4 phares (Bright Pi v1.0)</li>
<li>GPS (Ultimate GPS Breakout v3)</li>
<li>&#xC9;metteur WiFi (ASUS RT-AC58U)</li>
<li>LEGO 4x4 X-trem Off-Roader</li>
<li>D&#xE9;tecteur infrarouge (Flying-Fish)</li>
<li>Radar 360 (RPLiDAR A2M8)</li>
</ul>
<h3 class="mume-header" id="environnement-de-d%C3%A9veloppement">Environnement de d&#xE9;veloppement</h3>

<p>Pour me connecter au Raspberry Pi sur lequel je travail, j&apos;utilise :</p>
<ul>
<li>Remote SSH pour &#xE9;diter le code
<ul>
<li>Il s&apos;agit d&apos;une extension Visual Studio Code disponible <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh">ici</a></li>
</ul>
</li>
<li>Github pour publi&#xE9; mon code &#xE9;crit sur le Raspberry Pi et pour mettre &#xE0; disposition la documentation technique ainsi que le journal de bord</li>
<li>RealVNC pour me connecter &#xE0; distance &#xE0; l&apos;interface graphique du Raspberry Pi
<ul>
<li>Il s&apos;agit d&apos;un logiciel cr&#xE9;ant un serveur et un client permettant de contr&#xF4;ler &#xE0; distance l&apos;&#xE9;cran d&apos;un autre ordinateur, disponible <a href="https://www.realvnc.com/fr/connect/download/viewer/">ici</a>.</li>
</ul>
</li>
</ul>
<h2 class="mume-header" id="description-d%C3%A9taill%C3%A9e-de-ce-que-lapplication-fait">Description d&#xE9;taill&#xE9;e de ce que l&apos;application fait</h2>

<p>La voiture est t&#xE9;l&#xE9;commandable &#xE0; distance &#xE0; l&apos;aide d&apos;une interface web. Sur le site internet, on a acc&#xE8;s &#xE0; la gestion des &#xE9;tats des diff&#xE9;rents capteurs ainsi que des donn&#xE9;es qu&apos;ils envoient tel que pour la d&#xE9;tection sol, le radar 360&#xB0; ainsi que pour le flux vid&#xE9;o des cam&#xE9;ras.</p>
<h3 class="mume-header" id="plan-de-la-voiture">Plan de la voiture</h3>

<p><img src="./images/maquettes/plan_voiture_avec_composants_v2.jpg" alt="Croquis du plan de la voiture" title="Croquis du plan de la voiture"><br>
Dans le croquis du plan de la voiture pr&#xE9;sent ci-dessus, je vais &#xE9;noncer le r&#xF4;le de chaque composant.</p>
<ol>
<li>Les phares sont repr&#xE9;sent&#xE9;s par le Bright Pi</li>
<li>Les d&#xE9;tecteurs de sol plac&#xE9;s au niveau des roues sont repr&#xE9;sent&#xE9;s par le Flying-Fish</li>
<li>Le Raspberry Pi 4 est repr&#xE9;sent&#xE9; par RSP 4</li>
<li>Le Raspberry Pi 0 WiFi est repr&#xE9;sent&#xE9; par RSP 0 W</li>
<li>Le scanner 360&#xB0; est repr&#xE9;sent&#xE9; par le Lidar</li>
</ol>
<p>En comparaison, voici de quoi est &#xE9;quip&#xE9;e une vraie voiture autonome :</p>
<p><img src="./images/plans/autonomous_car.png" alt="Plan d&apos;une voiture autonome" title="Plan d&apos;une voiture autonome"></p>
<h3 class="mume-header" id="sch%C3%A9ma-explicatif-de-lapplication">Sch&#xE9;ma explicatif de l&apos;application</h3>

<p>L&apos;application offre plusieurs pages.</p>
<h3 class="mume-header" id="interface-utilisateur-de-lapplication">Interface utilisateur de l&apos;application</h3>

<p>Une page d&apos;interface utilisateur, pour avoir acc&#xE8;s aux informations des capteurs ainsi que leurs &#xE9;tats.</p>
<p><img src="./images/maquettes/interface.png" alt="Interace utilisateur" title="Interace utilisateur"></p>
<h3 class="mume-header" id="interface-t%C3%A9l%C3%A9commande">Interface t&#xE9;l&#xE9;commande</h3>

<p>Une page de t&#xE9;l&#xE9;commande pour la voiture.</p>
<h4 class="mume-header" id="en-mode-manuel">En mode manuel</h4>

<p>L&apos;utilisateur d&#xE9;place la voiture &#xE0; l&apos;aide de la manette disponible sur le site web.</p>
<p><img src="./images/maquettes/commande_de_la_voiture.png" alt="Interface de t&#xE9;l&#xE9;commande en mode manuel" title="Interface de t&#xE9;l&#xE9;commande en mode manuel"></p>
<h4 class="mume-header" id="en-mode-automatique">En mode automatique</h4>

<p>La voiture se d&#xE9;place de mani&#xE8;re rectiligne en &#xE9;vitant les obstacles sur sa route.</p>
<p><img src="./images/maquettes/commande_de_la_voiture_automatique.png" alt="Interface de t&#xE9;l&#xE9;commande en mode automatique" title="Interface de t&#xE9;l&#xE9;commande en mode automatique"></p>
<h1 class="mume-header" id="contact">Contact</h1>

<table>
<thead>
<tr>
<th>Status</th>
<th style="text-align:center">Nom</th>
<th style="text-align:center">Pr&#xE9;nom</th>
<th style="text-align:center">Email</th>
<th>Num&#xE9;ro de t&#xE9;l&#xE9;phone</th>
</tr>
</thead>
<tbody>
<tr>
<td>&#xC9;l&#xE8;ve</td>
<td style="text-align:center">Ackermann</td>
<td style="text-align:center">Gawen</td>
<td style="text-align:center"><a href="mailto:gawen.ackrm@eduge.ch">gawen.ackrm@eduge.ch</a></td>
<td>+41 79 88 98 69 4</td>
</tr>
<tr>
<td>Professeur de dipl&#xF4;me</td>
<td style="text-align:center">Bonvin</td>
<td style="text-align:center">Pascal</td>
<td style="text-align:center"><a href="mailto:edu-bonvinp@eduge.ch">edu-bonvinp@eduge.ch</a></td>
<td>+33 6 32 17 84 11</td>
</tr>
</tbody>
</table>
<h1 class="mume-header" id="structure-du-projet">Structure du projet</h1>

<pre data-role="codeBlock" data-info class="language-"><code>&#x251C;&#x2500;&#x2500; code
&#x2502;   &#x251C;&#x2500;&#x2500; Bluetooth
&#x2502;   &#x251C;&#x2500;&#x2500; Bright Pi
&#x2502;   &#x251C;&#x2500;&#x2500; Camera
&#x2502;   &#x251C;&#x2500;&#x2500; Flask
&#x2502;   &#x251C;&#x2500;&#x2500; Flying-Fish
&#x2502;   &#x251C;&#x2500;&#x2500; Lidar
&#x2502;   &#x2514;&#x2500;&#x2500; OpenCV
&#x251C;&#x2500;&#x2500; docs
&#x2502;   &#x251C;&#x2500;&#x2500; images
&#x2502;   &#x251C;&#x2500;&#x2500; plans
&#x2502;   &#x251C;&#x2500;&#x2500; documentation_technique.md
&#x2502;   &#x251C;&#x2500;&#x2500; index.md
&#x2502;   &#x251C;&#x2500;&#x2500; logbook.md
&#x2502;   &#x2514;&#x2500;&#x2500; requirements.txt
&#x251C;&#x2500;&#x2500; site
&#x2502;   &#x251C;&#x2500;&#x2500; assets
&#x2502;   &#x251C;&#x2500;&#x2500; documentation_technique
&#x2502;   &#x251C;&#x2500;&#x2500; images
&#x2502;   &#x251C;&#x2500;&#x2500; logbook
&#x2502;   &#x251C;&#x2500;&#x2500; plans
&#x2502;   &#x251C;&#x2500;&#x2500; search
&#x2502;   &#x251C;&#x2500;&#x2500; 404.html
&#x2502;   &#x251C;&#x2500;&#x2500; index.html
&#x2502;   &#x251C;&#x2500;&#x2500; sitemap.xml
&#x2502;   &#x2514;&#x2500;&#x2500; sitemap.xml.gz
&#x251C;&#x2500;&#x2500; mkdocs.yml
&#x2514;&#x2500;&#x2500; README.md
</code></pre><h1 class="mume-header" id="d%C3%A9veloppement">D&#xE9;veloppement</h1>

<p>Dans cette section, nous aborderons la mise en place de base des diff&#xE9;rents capteurs utilis&#xE9;s.</p>
<h2 class="mume-header" id="description-d%C3%A9taill%C3%A9e-de-chaques-capteurs">Description d&#xE9;taill&#xE9;e de chaques capteurs</h2>

<h3 class="mume-header" id="raspberry-pi">Raspberry Pi</h3>

<p>Il s&apos;agit d&apos;un mini-ordinateur de la taille d&apos;une carte de cr&#xE9;dit &#xE9;quip&#xE9;s de diff&#xE9;rents capteurs, cela d&#xE9;pends du mod&#xE8;le.</p>
<h4 class="mume-header" id="mise-en-place">Mise en place</h4>

<p>En fonction du mod&#xE8;le du Raspberry Pi, il faut flasher les cartes SD avec diff&#xE9;rents OS avec le <a href="https://www.raspberrypi.org/software/">Raspberry Pi Imager</a> :</p>
<ul>
<li>Pour un Raspberry Pi 4, install&#xE9; la version <code>Raspberry Pi OS Full (32-bit)</code> pour faire les tests &#xE0; l&apos;aide d&apos;une interface graphique</li>
<li>Pour un Raspberry 0 WiFi, install&#xE9; la version <code>Raspberry Pi OS Lite (32-bit)</code> utilis&#xE9; juste pour transiter des donn&#xE9;es</li>
</ul>
<h4 class="mume-header" id="utilisation">Utilisation</h4>

<h5 class="mume-header" id="pi-4">Pi 4</h5>

<p>Un Raspberry Pi 4B est constitu&#xE9; des diff&#xE9;rents &#xE9;l&#xE9;ments :</p>
<p><img src="./images/raspberrys/rsp4_schema_captionned.png" alt="Sch&#xE9;ma du Raspberry Pi 4 montrant o&#xF9; se situent chaques composants" title="Sch&#xE9;ma du Raspberry Pi montrant o&#xF9; se situent chaques composants"> Pour le <a href="######Pi-4">GPIO</a>, voici les pins disponibles :</p>
<p><img src="./images/raspberrys/GPIO-Pinout-Diagram.png" alt="Sch&#xE9;ma du Raspberry Pi montrant o&#xF9; se situe les GPIO (General Purpose Input/Output)" title="Sch&#xE9;ma du Raspberry Pi montrant o&#xF9; se situe les GPIO (General Purpose Input/Output)"><br>
&#xC0; noter, la pin num&#xE9;ro 1 se situe &#xE0; c&#xF4;t&#xE9; du module Bluetooth tandis que la pin 39 se situe en diagonal du <code>PoE HAT Header</code>.</p>
<h5 class="mume-header" id="pi-0-wifi">Pi 0 WiFi</h5>

<p>Le Pi 0 WiFi d&#xE9;tient moins d&apos;&#xE9;l&#xE9;ments que le Pi 4, cependant il en d&#xE9;tient quelque-uns de diff&#xE9;rents tel que :</p>
<p><img src="./images/raspberrys/rsp0wifi_schema_captionned.png" alt="Sch&#xE9;ma du Raspberry Pi 0 Wifi montrant o&#xF9; se situent chaques composants" title="Sch&#xE9;ma du Raspberry Pi 0 Wifi montrant o&#xF9; se situent chaques composants"></p>
<h5 class="mume-header" id="clonage-de-carte-sd">Clonage de carte SD</h5>

<p>Pour cloner les cartes SD, j&apos;utilise le programme <a href="https://www.balena.io/etcher/">balenaEtcher</a>.<br>
Une fois les cartes SD branch&#xE9;es en USB au PC, lorsque le programme est lanc&#xE9;, il faut s&#xE9;lectionner le disque &#xE0; copier, puis le disque sur lequel la copie doit &#xEA;tre effectu&#xE9;e et cliquer sur <code>Flash</code> :</p>
<p><img src="./images/clone_sd/balenaEtcher_differentes_etapes.png" alt="Diff&#xE9;rentes &#xE9;tapes d&apos;utilisation de balenaEtcher" title="Diff&#xE9;rentes &#xE9;tapes d&apos;utilisation de balenaEtcher"></p>
<h3 class="mume-header" id="ventilateur">Ventilateur</h3>

<p>Un ventilateur dans le cadre informatique est utilis&#xE9; afin de faire descendre sa temp&#xE9;rature car lorsqu&apos;il fait beaucoup de calcul en m&#xEA;me temps il surchauffe et ceci peut causer des probl&#xE8;mes pour la carte.</p>
<p>Le ventilateur est n&#xE9;cessaire car lorsque toutes les cam&#xE9;ras sont allum&#xE9;es et que le lidar tourne, sans le ventilateur, le processeur atteint des temp&#xE9;ratures exc&#xE9;dant 70&#xB0; Celcius tandis qu&apos;avec le ventilateur cette temp&#xE9;rature est limit&#xE9;e &#xE0; 55&#xB0; Celcius.</p>
<p>Entre temps, je suis pass&#xE9; du ventilateur de gauche &#xE0; celui de droite :</p>
<p><img src="./images/differents_ventilateurs.jpg" alt="Deux ventilateurs que j&apos;ai utilis&#xE9;" title="Deux ventilateurs que j&apos;ai utilis&#xE9;"></p>
<p>Celui de gauche &#xE9;tait temporaire. Je l&apos;avais d&#xE9;mont&#xE9; d&apos;un vieux disque dur, car j&apos;avais demand&#xE9; &#xE0; ce que l&apos;on en commande pour un raspberry pi &#xE9;tant donn&#xE9; que mon processeur surchauffait.</p>
<h4 class="mume-header" id="mise-en-place-1">Mise en place</h4>

<p>Pour le connecter, il faut brancher le c&#xE2;ble d&apos;alimentation (rouge) sur la pin 4, le c&#xE2;ble de la terre (noir) sur la pin 6 et le c&#xE2;ble de transmission (bleu) sur la pin 8  du GPIO comme le montre la bo&#xEE;te dans laquelle le ventilateur &#xE9;tait :</p>
<p><img src="./images/ventilateur_branchement.jpg" alt="Branchement du ventilateur pour le Raspberry Pi" title="Branchement du ventilateur pour le Raspberry Pi"></p>
<p>&#xC9;tant donn&#xE9; qu&apos;il est fournit avec un socle, socle qui est enlevable. Je ne l&apos;ai pas enlev&#xE9; car sinon il aurait &#xE9;t&#xE9; difficle de faire tenir le ventilateur car il toucherait le processeur. C&apos;est pourquoi j&apos;ai utilis&#xE9; un &#xE9;lastique afin de le maintenant sur le Raspberry Pi 4 :</p>
<p><img src="./images/ventilateur_elastique_rsp.jpg" alt="Placement du ventilateur avec un &#xE9;lastique" title="Placement du ventilateur avec un &#xE9;lastique"></p>
<p>L&apos;&#xE9;lastique passe sous le Raspberry Pi 4, et tiens sur les branches de c&#xF4;t&#xE9;s.</p>
<h3 class="mume-header" id="cam%C3%A9ra">Cam&#xE9;ra</h3>

<p>La cam&#xE9;ra est un module permettant d&apos;avoir acc&#xE8;s &#xE0; un flux vid&#xE9;o.</p>
<h4 class="mume-header" id="mise-en-place-2">Mise en place</h4>

<p>J&#x2019;ai utilis&#xE9; le guide de la cam&#xE9;ra disponible sur <a href="https://magpi.raspberrypi.org/books">https://magpi.raspberrypi.org/books</a>. Pour commencer, j&#x2019;ai activ&#xE9; la cam&#xE9;ra dans le panneau de configuration du Raspberry Pi, puis j&#x2019;ai branch&#xE9; la cam&#xE9;ra dans l&#x2019;emplacement pr&#xE9;vu qui se situe entre la prise jack et les ports HDMI.</p>
<p>Si vous branchez une cam&#xE9;ra &#xE0; un Pi 4 :</p>
<p><img src="./images/raspberrys/rsp4_cameras_slot_emplacement.png" alt="Sch&#xE9;ma du Raspberry Pi 4 montrant o&#xF9; se situe le port d&#x2019;entr&#xE9; pour la cam&#xE9;ra" title="Sch&#xE9;ma du Raspberry Pi 4 montrant o&#xF9; se situe le port d&#x2019;entr&#xE9; pour la cam&#xE9;ra"></p>
<p>Si vous branchez une cam&#xE9;ra &#xE0; un Pi 0 WiFi :</p>
<p><img src="./images/raspberrys/rsp0wifi_cameras_slot_emplacement.png" alt="Sch&#xE9;ma du Raspberry Pi 0 WiFi montrant o&#xF9; se situe le port d&#x2019;entr&#xE9; pour la cam&#xE9;ra" title="Sch&#xE9;ma du Raspberry Pi 0 WiFi montrant o&#xF9; se situe le port d&#x2019;entr&#xE9; pour la cam&#xE9;ra"></p>
<p>Le ruban de la cam&#xE9;ra doit &#xEA;tre plac&#xE9; de sorte &#xE0; ce que la languette bleue fasse face &#xE0; la prise jack. Pour m&#x2019;assurer que la cam&#xE9;ra soit fonctionnelle, j&#x2019;utilise la commande suivante pour prendre une photo <code>raspistill -o test.jpg</code>.</p>
<p>&#xC0; noter que si vous utiliser une cam&#xE9;ra sur un Raspberry Pi 0 WiFi, il faut le c&#xE2;ble orange comme ci-dessous :</p>
<p><img src="./images/raspberrys/camera-cables.png" alt="Diff&#xE9;rents c&#xE2;bles pour la cam&#xE9;ra" title="Diff&#xE9;rents c&#xE2;bles pour la cam&#xE9;ra"></p>
<h4 class="mume-header" id="utilisation-1">Utilisation</h4>

<p>Pour v&#xE9;rifier qu&apos;un flux vid&#xE9;o pouvait &#xEA;tre lu, j&apos;ai utilis&#xE9; le code ci-dessous :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">from</span> picamera <span class="token keyword">import</span> PiCamera
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

camera <span class="token operator">=</span> PiCamera<span class="token punctuation">(</span><span class="token punctuation">)</span>

camera<span class="token punctuation">.</span>start_preview<span class="token punctuation">(</span><span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
camera<span class="token punctuation">.</span>stop_preview<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>&#xC0; noter, il est n&#xE9;cessaire d&apos;ex&#xE9;cuter ce code depuis le Raspberry Pi et non par VNC, car l&apos;affichage de la pr&#xE9;visualisation du flux ne s&apos;affiche pas. D&apos;apr&#xE8;s <a href="https://raspberrypi.stackexchange.com/questions/29537/sending-raspberry-pi-camera-preview-to-a-laptop-running-vnc-viewer">ce post</a> disponible sur StackEchange, il semblerait que l&apos;aper&#xE7;u de la cam&#xE9;ra soit g&#xE9;r&#xE9; &#xE0; un bas niveau dans le processeur graphique et par cons&#xE9;quent n&apos;est visible que par le moniteur directement branch&#xE9; au Raspberry Pi.</p>
<h3 class="mume-header" id="phare-bright-pi-v10">Phare (Bright Pi v1.0)</h3>

<p>Le Bright Pi est un module comportant 4 leds infrarouges situ&#xE9;es aux extr&#xE9;mit&#xE9;s et au centre 8 leds.</p>
<h4 class="mume-header" id="mise-en-place-3">Mise en place</h4>

<p>Pour l&#x2019;utilisation du Bright Pi, je me suis bas&#xE9; sur le guide disponible &#xE0; l&#x2019;adresse suivante : <a href="https://learn.pi-supply.com/make/bright-pi-quickstart-faq/">https://learn.pi-supply.com/make/bright-pi-quickstart-faq/</a>. J&#x2019;ai commenc&#xE9; par activer l&#x2019;I2C dans le panneau de configuration du Raspberry Pi puis j&#x2019;ai branch&#xE9; les pins aux emplacements indiqu&#xE9;s dans le guide de d&#xE9;marrage. Les couleurs ci-dessous doivent &#xEA;tre respect&#xE9;es (pour le placement uniquement).<br>
<img src="./images/bright_pi_wiring.jpg" alt="Branchement du Bright Pi" title="Branchement du Bright Pi"></p>
<p>Pour s&apos;assurer que le branchement soit correct, il est n&#xE9;cessaire d&apos;utiliser la commande <code>i2cdetect -y 1</code>. Ceci devrait &#xEA;tre affich&#xE9; dans la console :</p>
<p><img src="./images/bright_pi_wiring_test.png" alt="Commande affichant le branchement du Bright Pi" title="Commande affichant le branchement du Bright Pi"></p>
<p>Pour tester le Bright Pi, il est n&#xE9;cessaire d&apos;avoir le kit de d&#xE9;veloppement disponible sur <a href="https://github.com/PiSupply/Bright-Pi">ce repos Github</a>.</p>
<h4 class="mume-header" id="utilisation-2">Utilisation</h4>

<p>Une fois cela fait, il faut importer les &#xE9;l&#xE9;ments concernant le brightpi avec</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">from</span> brightpi <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> time
</pre><p>Pour faire clignoter les leds manuellement (&#xE0; l&#x2019;aide de lignes de code) j&#x2019;aurai pu utiliser l&#x2019;objet BrightPi, mais j&#x2019;ai finalement utilis&#xE9; le BrightPiSpecialEffects, car il permet d&#x2019;avoir acc&#xE8;s &#xE0; des fonctions pr&#xE9;d&#xE9;finies concernant la manipulation des leds, par exemple &#xE0; les faire s&#x2019;allumer une &#xE0; une dans le sens des aiguilles d&#x2019;une montre, ce qui peut devenir utile par la suite du travail. Voici le code que j&apos;ai &#xE9;crit. Ce code permet de faire clignoter les leds d&apos;un c&#xF4;t&#xE9; sp&#xE9;cifi&#xE9;.</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">def</span> <span class="token function">blink</span><span class="token punctuation">(</span>repetitions<span class="token punctuation">,</span> speed<span class="token punctuation">,</span> right_leds<span class="token punctuation">,</span> left_leds<span class="token punctuation">,</span> side<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># fait clignoter les leds des c&#xF4;t&#xE9;s sp&#xE9;cifi&#xE9;s</span>
    duration <span class="token operator">=</span> speed <span class="token operator">/</span> <span class="token number">2</span>
    leds_to_activate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    leds_to_desactivate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> repetitions<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> side <span class="token operator">==</span> <span class="token string">&quot;L&quot;</span><span class="token punctuation">:</span>
            leds_to_activate <span class="token operator">=</span> left_leds
            leds_to_desactivate <span class="token operator">=</span> right_leds
        <span class="token keyword">if</span> side <span class="token operator">==</span> <span class="token string">&quot;R&quot;</span><span class="token punctuation">:</span>
            leds_to_activate <span class="token operator">=</span> right_leds
            leds_to_desactivate <span class="token operator">=</span> left_leds

        bright_special<span class="token punctuation">.</span>set_led_on_off<span class="token punctuation">(</span>leds_to_desactivate<span class="token punctuation">,</span> OFF<span class="token punctuation">)</span>
        bright_special<span class="token punctuation">.</span>set_led_on_off<span class="token punctuation">(</span>leds_to_activate<span class="token punctuation">,</span> ON<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>duration<span class="token punctuation">)</span>
        bright_special<span class="token punctuation">.</span>set_led_on_off<span class="token punctuation">(</span>leds_to_activate<span class="token punctuation">,</span> OFF<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>duration<span class="token punctuation">)</span>

bright_special <span class="token operator">=</span> BrightPiSpecialEffects<span class="token punctuation">(</span><span class="token punctuation">)</span>
bright_special<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>

RIGHT_LEDS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
LEFT_LEDS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>

blink<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> RIGHT_LEDS<span class="token punctuation">,</span> LEFT_LEDS<span class="token punctuation">,</span> <span class="token string">&quot;R&quot;</span><span class="token punctuation">)</span>
</pre><h3 class="mume-header" id="d%C3%A9tecteur-infrarouge-flying-fish">D&#xE9;tecteur infrarouge (Flying-Fish)</h3>

<p>Le Flying-Fish est un module comportant 2 leds infrarouges, une qui &#xE9;met et une autre qui re&#xE7;ois. Il est &#xE9;quip&#xE9; d&apos;un potentiom&#xE8;tre r&#xE9;glant la distance d&apos;&#xE9;mission.</p>
<h4 class="mume-header" id="mise-en-place-4">Mise en place</h4>

<p>Comme le montre ce sch&#xE9;ma, le Flying-Fish doit &#xEA;tre connect&#xE9; &#xE0; une alimentation ainsi qu&apos;&#xE0; un <em>Ground</em> (appel&#xE9; <em>Terre</em> en fran&#xE7;ais). La derni&#xE8;re broche est la sortie. C&apos;est-&#xE0;-dire que lorsque la distance d&apos;&#xE9;mission r&#xE9;gl&#xE9;e &#xE0; l&apos;aide du potentiom&#xE8;tre est d&#xE9;pass&#xE9;e, la lumi&#xE8;re d&apos;obstacle s&apos;&#xE9;teindra et cette broche enverra un signal &#xE9;lectrique informant du changement d&apos;&#xE9;tat.</p>
<p><img src="./images/schema_flying_fish.jpg" alt="Sch&#xE9;ma du module Flying-Fish" title="Commande affichant le branchement du Bright Pi"></p>
<p>Il faut importer l&apos;acc&#xE8;s au GPIO du Raspberry Pi avec :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">import</span> RPi<span class="token punctuation">.</span>GPIO <span class="token keyword">as</span> GPIO
</pre><h4 class="mume-header" id="utilisation-3">Utilisation</h4>

<p>C&apos;est pourquoi, j&apos;ai branch&#xE9; le <em>Vcc</em> sur la pin 1 du <a href="######Pi-4">GPIO</a>, car le voltage accept&#xE9; est compris entre 3 et 6 Volts, ensuite j&apos;ai branch&#xE9; le <em>Gnd</em> sur la pin 6. J&apos;ai branch&#xE9; le <em>Out</em> &#xE0; la pin 16 (GPIO 23). Voici le code de test :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">import</span> RPi<span class="token punctuation">.</span>GPIO <span class="token keyword">as</span> GPIO
<span class="token keyword">import</span> time

<span class="token comment"># Set the mode into Broadcom SOC channel</span>
<span class="token comment"># It allows to use GPIO number instead of pin number</span>
GPIO<span class="token punctuation">.</span>setmode<span class="token punctuation">(</span>GPIO<span class="token punctuation">.</span>BCM<span class="token punctuation">)</span>

<span class="token comment"># Set the GPIO 23 into input mode</span>
GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>IN<span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token comment"># The actual state of the GPIO 23</span>
    input_state <span class="token operator">=</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> input_state <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;ATTENTION ! IL N&apos;Y A PLUS DE SOL !&quot;</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Sol d&#xE9;tect&#xE9;&quot;</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
</pre><h3 class="mume-header" id="connexion-bluetooth-avec-le-lego-4x4-x-trem-off-roader">Connexion bluetooth avec le LEGO 4x4 X-trem Off-Roader</h3>

<p>Le LEGO 4x4 X-trem Off-Roader est une voiture t&#xE9;l&#xE9;commandable en bluetooth.</p>
<h4 class="mume-header" id="mise-en-place-5">Mise en place</h4>

<p>Dans un premier temps, il faut installer <code>bleak</code>, <code>pygatt</code> et <code>bluepy</code> pour ce faire, j&apos;ai utilis&#xE9; cette commande : <code>sudo pip3 install pygatt &amp;&amp; pip3 install gatt &amp;&amp; pip3 install gattlib &amp;&amp; pip3 install bluepy &amp;&amp; pip3 install bleak</code> puis j&apos;ai t&#xE9;l&#xE9;charger le code sources du <a href="https://github.com/undera/pylgbst">repository pylgbst</a>.<br>
Pour tester la connexion bluetooth, j&apos;ai lanc&#xE9; la commande <code>sudo bluetoothctl</code>, ensuite j&apos;ai lanc&#xE9; les commandes suivantes : <code>power on</code> pour m&apos;assurer que le service soit actif, puis <code>scan on</code>. Une fois que des appareils ont &#xE9;t&#xE9; d&#xE9;tect&#xE9;s, on peut lancer l&apos;interface graphique situ&#xE9;e dans la barre des t&#xE2;ches :</p>
<p><img src="./images/raspberrys/rsp_bluetooth.png" alt="Bluetooth interface depuis barre des t&#xE2;ches" title="Bluetooth interface depuis barre des t&#xE2;ches"><br>
ou il est possible d&apos;aller dans les pr&#xE9;f&#xE9;rences pour l&apos;ouvrir :</p>
<p><img src="./images/raspberrys/rsp_bluetooth_from_preferences.png" alt="Bluetooth interface depuis les pr&#xE9;f&#xE9;rences" title="Bluetooth interface depuis les pr&#xE9;f&#xE9;rences">.</p>
<p>Une fois cette interface ouverte, il faut cliquer sur le bouton <em>Rechercher</em>, ce qui effectuera un scan des alentours. Une fois le <code>Technic Hub</code> trouv&#xE9; dans la liste, il est n&#xE9;cessaire de noter son adresse mac : <code>90:84:2B:50:36:43</code> afin de pouvoir l&apos;utiliser par la suite.</p>
<h4 class="mume-header" id="utilisation-4">Utilisation</h4>

<p>Pour g&#xE9;rer le d&#xE9;placement de la voiture, &#xE0; l&apos;aide du kit de d&#xE9;veloppement fournit par pylgbst, voici le code que j&apos;ai &#xE9;crit :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">from</span> pylgbst<span class="token punctuation">.</span>hub <span class="token keyword">import</span> MoveHub
<span class="token keyword">from</span> pylgbst<span class="token punctuation">.</span>peripherals <span class="token keyword">import</span> Motor<span class="token punctuation">,</span> EncodedMotor
<span class="token keyword">from</span> pylgbst <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

MY_MOVEHUB_ADD <span class="token operator">=</span> <span class="token string">&quot;90:84:2B:50:36:43&quot;</span>
MY_BTCTRLR_HCI <span class="token operator">=</span> <span class="token string">&quot;hci0&quot;</span>

<span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>motor_1<span class="token punctuation">,</span> motor_2<span class="token punctuation">,</span> motor_3<span class="token punctuation">)</span><span class="token punctuation">:</span>
    motor_1<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    motor_2<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    motor_3<span class="token punctuation">.</span>angled<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;done!&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">downward</span><span class="token punctuation">(</span>motor_1<span class="token punctuation">,</span> motor_2<span class="token punctuation">,</span> motor_3<span class="token punctuation">)</span><span class="token punctuation">:</span>
    motor_1<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    motor_2<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    motor_3<span class="token punctuation">.</span>angled<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;done!&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">go_left</span><span class="token punctuation">(</span>motor_3<span class="token punctuation">)</span><span class="token punctuation">:</span>
    motor_3<span class="token punctuation">.</span>angled<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">180</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;done!&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">go_right</span><span class="token punctuation">(</span>motor_3<span class="token punctuation">)</span><span class="token punctuation">:</span>
    motor_3<span class="token punctuation">.</span>angled<span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;done!&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">stop_moving</span><span class="token punctuation">(</span>motor_1<span class="token punctuation">,</span> motor_2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    motor_1<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    motor_2<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;done!&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">reset_angle</span><span class="token punctuation">(</span>motor_3<span class="token punctuation">)</span><span class="token punctuation">:</span>
    motor_3<span class="token punctuation">.</span>angled<span class="token punctuation">(</span>degrees<span class="token operator">=</span><span class="token operator">-</span><span class="token number">150</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;test 1&quot;</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    motor_3<span class="token punctuation">.</span>angled<span class="token punctuation">(</span>degrees<span class="token operator">=</span><span class="token operator">-</span><span class="token number">75</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;test 2&quot;</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">play_scenario</span><span class="token punctuation">(</span>movehub<span class="token punctuation">)</span><span class="token punctuation">:</span>
    motor_a <span class="token operator">=</span> Motor<span class="token punctuation">(</span>movehub<span class="token punctuation">,</span> movehub<span class="token punctuation">.</span>PORT_A<span class="token punctuation">)</span>
    motor_b <span class="token operator">=</span> Motor<span class="token punctuation">(</span>movehub<span class="token punctuation">,</span> movehub<span class="token punctuation">.</span>PORT_B<span class="token punctuation">)</span>
    motor_c <span class="token operator">=</span> EncodedMotor<span class="token punctuation">(</span>movehub<span class="token punctuation">,</span> movehub<span class="token punctuation">.</span>PORT_C<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Reset angle:&quot;</span><span class="token punctuation">)</span>
    reset_angle<span class="token punctuation">(</span>motor_c<span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Forward:&quot;</span><span class="token punctuation">)</span>
    forward<span class="token punctuation">(</span>motor_a<span class="token punctuation">,</span> motor_b<span class="token punctuation">,</span> motor_c<span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Downward:&quot;</span><span class="token punctuation">)</span>
    downward<span class="token punctuation">(</span>motor_a<span class="token punctuation">,</span> motor_b<span class="token punctuation">,</span> motor_c<span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Stop&quot;</span><span class="token punctuation">)</span>
    stop_moving<span class="token punctuation">(</span>motor_a<span class="token punctuation">,</span> motor_b<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Left:&quot;</span><span class="token punctuation">)</span>
    go_left<span class="token punctuation">(</span>motor_c<span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Right:&quot;</span><span class="token punctuation">)</span>
    go_right<span class="token punctuation">(</span>motor_c<span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">exiting</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;bye&quot;</span><span class="token punctuation">)</span>
    connection<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span><span class="token punctuation">)</span>

conn <span class="token operator">=</span> get_connection_gatt<span class="token punctuation">(</span>hub_mac<span class="token operator">=</span>MY_MOVEHUB_ADD<span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    movehub <span class="token operator">=</span> MoveHub<span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
    play_scenario<span class="token punctuation">(</span>movehub<span class="token punctuation">)</span>
    exiting<span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    exiting<span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
</pre><p>Le code fournit, propose diff&#xE9;rentes m&#xE9;thodes de connexion tel que :</p>
<ul>
<li>bluepy</li>
<li>bluegiga</li>
<li>gatt</li>
<li>bleak</li>
<li>gattool</li>
<li>gattlib</li>
</ul>
<p>Ayant vu dans plusieurs documentations le nom de <code>GATT</code> ressortir, je m&apos;y suis pench&#xE9; pour comprendre de quoi il s&apos;agissait. <code>GATT</code> est un acronyme de l&apos;anglais <em>Generic Attribute Profile</em>, il d&#xE9;finit comment les 2 appareils vont &#xE9;changer leurs donn&#xE9;es, tout en suivant un syst&#xE8;me de <em>Services</em> et de <em>Characteristics</em>. C&apos;est pourquoi j&apos;ai utilis&#xE9; la connexion avec <code>GATT</code>.</p>
<h4 class="mume-header" id="probl%C3%A8me-rencontr%C3%A9">Probl&#xE8;me rencontr&#xE9;</h4>

<p>Au d&#xE9;part, je tentais d&apos;appareiller le Raspberry Pi au Technic Hub depuis les commandes disponibles dans le mode <code>bluetoothctl</code>, mais j&apos;avais cette erreur <code>Failed to pair: org.bluez.Error.AuthenticationFailed</code>.</p>
<h5 class="mume-header" id="comment-je-lai-r%C3%A9solu">Comment je l&apos;ai r&#xE9;solu</h5>

<p>J&apos;ai alors compris que pour me connecter au Technic hub, j&apos;aurai besoin d&apos;y avoir acc&#xE8;s par un moyen qui permette de transmettre des donn&#xE9;es, car depuis la documentation LEGO, j&apos;ai aper&#xE7;u des commandes &#xE9;crites avec des bytes en hexad&#xE9;cimal. De plus,j&apos;ai remarqu&#xE9; qu&apos;ils mettaient &#xE0; disposition les UUID des hubs, car ils ont tous le m&#xEA;me fabricant.</p>
<p>Il y a plein de pistes que j&apos;ai entrevues sur les diff&#xE9;rents repository, cependant je ne m&apos;y &#xE9;tais pas int&#xE9;ress&#xE9; plus que &#xE7;a, car aucun ne mentionnait le nom de Technic Hub. Apr&#xE8;s avoir &#xE9;t&#xE9; dans les diff&#xE9;rents repository ci-dessous et apr&#xE8;s avoir regard&#xE9; comment &#xE9;taient &#xE9;crit leurs transmissions au hub bluetooth. J&apos;ai r&#xE9;ussi &#xE0; comprendre comment je pouvais m&apos;appareiller au Technic Hub et comment interagir avec.</p>
<h3 class="mume-header" id="radar-360-rplidar-a2m8">Radar 360 (RPLiDAR A2M8)</h3>

<p>Le RPLiDAR A2M8 est un scanner laser &#xE0; 360&#xB0;. Il permet de conna&#xEE;tre la distance entre lui et les obstacles &#xE0; chaque angles.</p>
<h4 class="mume-header" id="mise-en-place-6">Mise en place</h4>

<p>Le lidar est branchable par port s&#xE9;rie. Cependant, un adaptateur est fournie avec et nous permet de r&#xE9;cup&#xE9;rer les donn&#xE9;es par USB.</p>
<p><img src="./images/lidar/lidar_side_connection_modes.png" alt="Types de connexions" title="Types de connexions"></p>
<p>Au dos de l&apos;adaptateur, on peut y voir les &#xE9;l&#xE9;ments suivants :</p>
<p><img src="./images/lidar/lidar_back.png" alt="Informations inscrites au dos de l&apos;adaptateur" title="Informations inscrites au dos de l&apos;adaptateur"></p>
<table>
<thead>
<tr>
<th style="text-align:center">Couleur du c&#xE2;ble</th>
<th style="text-align:center">Nom du signal</th>
<th style="text-align:center">Type de signal</th>
<th style="text-align:center">Description</th>
<th style="text-align:center">Tension minimale</th>
<th style="text-align:center">Tension habituelle</th>
<th style="text-align:center">Tension maximale</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Rouge</td>
<td style="text-align:center">VCC</td>
<td style="text-align:center">Power</td>
<td style="text-align:center">Puissance totale</td>
<td style="text-align:center">4.9V</td>
<td style="text-align:center">5V</td>
<td style="text-align:center">5.2V</td>
</tr>
<tr>
<td style="text-align:center">Vert</td>
<td style="text-align:center">TX</td>
<td style="text-align:center">Output</td>
<td style="text-align:center">Sortie des donn&#xE9;es sur le port s&#xE9;rie relative au scanner</td>
<td style="text-align:center">0V</td>
<td style="text-align:center">3.3V</td>
<td style="text-align:center">3.5V</td>
</tr>
<tr>
<td style="text-align:center">Jaune</td>
<td style="text-align:center">RX</td>
<td style="text-align:center">Input</td>
<td style="text-align:center">Entr&#xE9;e des donn&#xE9;es sur le port s&#xE9;rie relative au scanner</td>
<td style="text-align:center">0V</td>
<td style="text-align:center">3.3V</td>
<td style="text-align:center">3.5V</td>
</tr>
<tr>
<td style="text-align:center">Noir</td>
<td style="text-align:center">GND</td>
<td style="text-align:center">Power</td>
<td style="text-align:center">La Terre</td>
<td style="text-align:center">0V</td>
<td style="text-align:center">0V</td>
<td style="text-align:center">0V</td>
</tr>
<tr>
<td style="text-align:center">Bleu</td>
<td style="text-align:center">MOTOCTL</td>
<td style="text-align:center">Input</td>
<td style="text-align:center">Moteur de scan, r&#xE9;gul&#xE9; avec un PWM</td>
<td style="text-align:center">0V</td>
<td style="text-align:center">3.3V</td>
<td style="text-align:center">5V</td>
</tr>
</tbody>
</table>
<p>Informations compl&#xE9;mentaires pour le PWM, voici les valeurs utilis&#xE9;es :</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Unit&#xE9;</th>
<th style="text-align:center">Valeur minimale</th>
<th style="text-align:center">Valeur habituelle</th>
<th style="text-align:center">Valeur maximale</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Haut niveau de tension</td>
<td style="text-align:center">Volts</td>
<td style="text-align:center">3.0</td>
<td style="text-align:center">3.3</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center">Fr&#xE9;quence du PWM</td>
<td style="text-align:center">Herz</td>
<td style="text-align:center">24,500</td>
<td style="text-align:center">25,000</td>
<td style="text-align:center">25,500</td>
</tr>
<tr>
<td style="text-align:center">Plage de cycles d&apos;utilisation</td>
<td style="text-align:center">Pourcent</td>
<td style="text-align:center">0</td>
<td style="text-align:center">60</td>
<td style="text-align:center">100</td>
</tr>
</tbody>
</table>
<p>Si on le souhaite, on peut modifier la vitesse de transmission. De base, la vitesse de transmission est param&#xE9;tr&#xE9;e sur 115&apos;200 Baud, mais on peut la mont&#xE9;e &#xE0; 256&apos;000 Baud.</p>
<p><img src="./images/lidar/lidar_up_and_side_baudrate.png" alt="Vitesse de transmission du Lidar" title="Vitesse de transmission du Lidar"></p>
<p>Il faut commencer par t&#xE9;l&#xE9;charger le kit de d&#xE9;veloppement disponible sur <a href="https://github.com/Slamtec/rplidar_sdk/releases/tag/release%2Fv1.12.0">le repository officiel de Slamtec</a>. Une fois le SDK t&#xE9;l&#xE9;charg&#xE9; sur le Raspberry. Nous pouvons brancher le Lidar &#xE0; l&apos;adaptateur. Depuis l&apos;adaptateur, branch&#xE9; le micro-USB dessus puis l&apos;USB au Raspberry Pi.</p>
<p><img src="./images/lidar/20210427_124335.jpg" alt="Branchement du Lidar &#xE0; l&apos;adaptateur" title="Branchement du Lidar &#xE0; l&apos;adaptateur"></p>
<h4 class="mume-header" id="utilisation-5">Utilisation</h4>

<p>Afin de v&#xE9;rifier qu&apos;il soit bien d&#xE9;tecter, il faut ex&#xE9;cuter la commande suivante <code>ls /dev/*USB*</code> ceci devrait &#xEA;tre retourn&#xE9; <code>/dev/ttyUSB0</code>. Dans le dossier du code source, il faut aller dans le r&#xE9;pertoire <code>sdk/app/</code> et ex&#xE9;cuter la commande make dans un terminal. Pour ex&#xE9;cuter l&apos;un des 3 programmes suivant :</p>
<ol>
<li>ultra_simple</li>
<li>simple_grabber</li>
<li>frame_grabber</li>
</ol>
<p>Nous pouvons maintenant ex&#xE9;cuter le programme souhait&#xE9; en utilisant la commande suivante dans un terminal : <code>nom_du_programme /dev/ttyUSB0</code>.</p>
<h4 class="mume-header" id="probl%C3%A8me-rencontr%C3%A9-1">Probl&#xE8;me rencontr&#xE9;</h4>

<p>Les codes fournis fonctionnent parfaitement, sauf qu&apos;aucun ne permet de r&#xE9;cup&#xE9;rer depuis une variable ou autre les valeurs d&apos;angles. Cependant, elles sont affich&#xE9;es dans la console.</p>
<h5 class="mume-header" id="comment-je-lai-r%C3%A9solu-1">Comment je l&apos;ai r&#xE9;solu</h5>

<p>Il y avait 2 possibilit&#xE9;s :</p>
<ol>
<li>La premi&#xE8;re &#xE9;tait de r&#xE9;cup&#xE9;rer les c&#xE2;bles s&#xE9;ries (rouge, bleu, jaune, ...) et de les connecter directement au <a href="#####Pi-4">GPIO</a> sur les pins qui fournissent :
<ul>
<li>TX</li>
<li>RX</li>
<li>VCC</li>
<li>Ground</li>
<li>MotorCTL est un PWM</li>
</ul>
</li>
</ol>
<p>Comme indiqu&#xE9; sur ce sch&#xE9;ma du GPIO du raspberry pi de mani&#xE8;re plus d&#xE9;taill&#xE9; que le premier vu dans la section parlant des Raspberry Pi :</p>
<p><img src="./images/raspberrys/GPIO-Pinout-Diagram_detailed.png" alt="Branchement du Lidar &#xE0; l&apos;adaptateur" title="Branchement du Lidar &#xE0; l&apos;adaptateur"></p>
<p>Il s&apos;agirait donc des pins : 2 (VCC), 6 (GND), 8 (TX), 9 (RX)</p>
<ol start="2">
<li>La seconde option &#xE9;tait de r&#xE9;cup&#xE9;rer les donn&#xE9;es que l&apos;API de Slamtec, <a href="https://github.com/Slamtec/rplidar_sdk/releases">ici pr&#xE9;sente</a> &#xE9;crite en <code>C++</code>. Cette derni&#xE8;re fournissait les donn&#xE9;es en les affichant dans la console sous un format : <code>Theta: 210.31 Dist: 00875.00</code>, Theta repr&#xE9;sentant un angle et Dist repr&#xE9;sentant la distance en millim&#xE8;tre d&apos;un obstacle.<br>
Malheureusement trop tard, j&apos;ai trouv&#xE9; <a href="https://rplidar.readthedocs.io/en/latest/">cette librairie</a> en python qui faisait quasiment tout le travail &#xE0; ma place.</li>
</ol>
<p>Cela dit, la m&#xE9;thode que j&apos;utilise actuellement se r&#xE9;sume &#xE0; &#xE7;a :</p>
<p><img src="./images/lidar/flowchart_lidar_api.png" alt="M&#xE9;thode utilis&#xE9;e pour r&#xE9;cup&#xE9;rer en temps r&#xE9;el les donn&#xE9;es du Lidar" title="M&#xE9;thode utilis&#xE9;e pour r&#xE9;cup&#xE9;rer en temps r&#xE9;el les donn&#xE9;es du Lidar"></p>
<p>Le probl&#xE8;me de cette m&#xE9;thode est qu&apos;elle n&apos;est vraiment pas optimis&#xE9;e car on va lire de mani&#xE8;re asynchrone les donn&#xE9;es re&#xE7;ues par le programme <code>C++</code> et trait&#xE9;e puis mise dans le tableau de distance &#xE0; chaque it&#xE9;ration. Cette m&#xEA;me it&#xE9;ration est stoppable &#xE0; tout moment avec un param&#xE8;tre &#xE0; changer dans le lancement du processus.</p>
<h3 class="mume-header" id="%C3%A9metteur-wifi-asus-rt-ac58u">&#xC9;metteur WiFi (ASUS RT-AC58U)</h3>

<p>Un &#xE9;metteur sans fil diffuse des ondes en utilisant la fr&#xE9;quence radio (RF). Il permet de rendre une connexion internet sans y &#xEA;tre connect&#xE9; de mani&#xE8;re filaire. Pour ce projet, nous utilisons un ASUS RT-AC58U.</p>
<h4 class="mume-header" id="mise-en-place-7">Mise en place</h4>

<h5 class="mume-header" id="branchement">Branchement</h5>

<p>Pour mettre en place le routeur, il faut d&apos;abord brancher l&apos;alimentation dans le port indiqu&#xE9; ainsi que le c&#xE2;ble ethernet permettant la connexion &#xE0; internet dans le port bleu. Pour r&#xE9;cup&#xE9;rer les sorties ethernet, il faut les brancher dans les ports jaunes.</p>
<p><img src="./images/asus_wifi/router_branchement.png" alt="Branchements &#xE0; faire pour le routeur" title="Branchements &#xE0; faire pour le routeur"></p>
<p>Sur le haut du routeur, on peut voir diff&#xE9;rentes leds s&apos;allumer, voici la signification de ces derni&#xE8;res :</p>
<p><img src="./images/asus_wifi/router_leds_signification.png" alt="Branchements &#xE0; faire pour le routeur" title="Branchements &#xE0; faire pour le routeur"></p>
<p>Une fois que le branchement est fait, il faut se rendre sur <a href="http://router.asus.com/">http://router.asus.com/</a>, la page de connexion vous sera alors affich&#xE9;e. Par d&#xE9;faut, les identifiants pour s&apos;y connecter sont pour le nom d&apos;utilisateur ainsi que pour le mot de passe <code>admin</code>.</p>
<p><img src="./images/asus_wifi/page_connexion.png" alt="Page de connexion" title="Page de connexion"></p>
<h5 class="mume-header" id="configuration">Configuration</h5>

<p>Pour commencer &#xE0; param&#xE9;trer le r&#xE9;seau, il faut en un premier temps cliquer sur le bouton <code>Quick Internet Setup</code></p>
<p><img src="./images/asus_wifi/bouton_configuration.png" alt="Bouton de configuration du r&#xE9;seau" title="Bouton de configuration du r&#xE9;seau"></p>
<p>Cette premi&#xE8;re page sera affich&#xE9;e, vous laissant le choix entre une configuration rapide ou d&#xE9;taill&#xE9;e. Le mode avanc&#xE9; n&apos;&#xE9;tant pas n&#xE9;cessaire, il est pr&#xE9;f&#xE9;rable de cliquer sur le bouton <code>Create A New Network</code></p>
<p><img src="./images/asus_wifi/configuration_creer_nouveau_reseau.png" alt="Cr&#xE9;ation d&apos;un nouveau r&#xE9;seau" title="Cr&#xE9;ation d&apos;un nouveau r&#xE9;seau"></p>
<p>Ensuite, cette page de configuration s&apos;affichera, et vous pourrez renter les diff&#xE9;rentes informations telles que le SSID (nom du r&#xE9;seau) et son mot de passe. Une fois les diff&#xE9;rents champs remplis, il faut cliquer sur <code>Apply</code>.</p>
<p><img src="./images/asus_wifi/configuration_creer_nouveau_reseau_differents_champs_a_remplir.png" alt="Champs &#xE0; remplir" title="Champs &#xE0; remplir"></p>
<p>Le routeur va nous demander si l&apos;on veut que <code>Yandex</code> soit active, son r&#xF4;le est de restreindre l&apos;acc&#xE8;s aux sites malicieux et aux contenus pour adulte. Dans mon cas, je l&apos;ai activ&#xE9; :</p>
<p><img src="./images/asus_wifi/configuration_creer_nouveau_reseau_yandex.png" alt="Activation de Yandex" title="Activation de Yandex"></p>
<p>Il est fort probable que vous deviez mettre &#xE0; jour votre appareil avec le firmware :</p>
<p><img src="./images/asus_wifi/configuration_creer_nouveau_reseau_firmware.png" alt="Mise &#xE0; jour du firmware" title="Mise &#xE0; jour du firmware"></p>
<h5 class="mume-header" id="changement-des-param%C3%A8tres-de-connexion-%C3%A0-linterface-web">Changement des param&#xE8;tres de connexion &#xE0; l&apos;interface web</h5>

<p>Pour modifier le nom d&apos;utilisateur ainsi que son mot de passe, il faut cliquer sur le bouton <code>Administration</code> :</p>
<p><img src="./images/asus_wifi/bouton_administration.png" alt="Bouton d&apos;administration du r&#xE9;seau" title="Bouton d&apos;administration du r&#xE9;seau"></p>
<p>Cette page s&apos;affichera, et il faudra cliquer sur l&apos;onglet <code>System</code> afin d&apos;avoir acc&#xE8;s &#xE0; l&apos;interface nous permettant de modifier ces informations :</p>
<p><img src="./images/asus_wifi/bouton_administration_system.png" alt="Onglet system" title="Onglet system"></p>
<p>Une fois dans l&apos;onglet, vous pourrez modifier les informations ici :</p>
<p><img src="./images/asus_wifi/bouton_administration_system_change_username_and_password.png" alt="Changement du nom d&apos;utilisateur ainsi que de son mot de passe pour se connecter &#xE0; l&apos;interface web" title="Changement du nom d&apos;utilisateur ainsi que de son mot de passe pour se connecter &#xE0; l&apos;interface web"></p>
<h4 class="mume-header" id="utilisation-6">Utilisation</h4>

<p>Il faut activer le WiFi sur l&apos;appareil que l&apos;on souhaite connecter, une fois les r&#xE9;seaux scann&#xE9;s. Nous devrions pouvoir avoir acc&#xE8;s au r&#xE9;seau <code>le_SSID_du_r&#xE9;seau</code> et s&apos;y connecter en entrant le mot de passe choisi sur l&apos;interface nous permettant de param&#xE9;trer notre r&#xE9;seau.</p>
<h2 class="mume-header" id="python-flask">Python Flask</h2>

<p>Flask est un framework web disponible en python qui permet de d&#xE9;velopper ais&#xE9;ment des applications web.</p>
<h3 class="mume-header" id="mise-en-place-8">Mise en place</h3>

<p>Flask est t&#xE9;l&#xE9;chargeable depuis la commande <code>pip3 install Flask</code>.</p>
<h3 class="mume-header" id="utilisation-7">Utilisation</h3>

<p>Dans un premier temps, il est important de cr&#xE9;er un fichier python. Dans cet exemple, ce sera <code>hello.py</code>.</p>
<h4 class="mume-header" id="application-de-base">Application de base</h4>

<p>Il faut d&apos;abord importer Flask. Et l&apos;initialiser de la mani&#xE8;re suivante :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&apos;Hello, World!&apos;</span>
</pre><p>Pour lancer l&apos;application, il faut d&apos;abord exporter la variable d&apos;environnment <code>FLASK_APP</code> de la mani&#xE8;re suivante dans un terminal : <code>export FLASK_APP=hello.py</code>. Une fois cela fait, lancer le serveur avec la commande : <code>flask run --host=0.0.0.0</code>. Le <code>--host=0.0.0.0</code> rend l&apos;acc&#xE8;s au serveur public depuis d&apos;autres appareils connect&#xE9;s sur le r&#xE9;seau. Dans mon cas, mon Raspberry Pi a cette adresse IP : <code>10.5.50.42</code> et mon PC <code>10.5.50.52</code>. Pour aller sur le site, je tape l&apos;adresse IP du Raspberry Pi ainsi que le port 5000, <a href="http://10.5.50.42:5000/">http://10.5.50.42:5000/</a>.</p>
<pre data-role="codeBlock" data-info class="language-"><code> * Serving Flask app &quot;hello.py&quot;
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)
127.0.0.1 - - [28/Apr/2021 08:42:15] &quot;GET / HTTP/1.1&quot; 200 -
127.0.0.1 - - [28/Apr/2021 08:42:16] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -
10.5.50.52 - - [28/Apr/2021 08:42:32] &quot;GET / HTTP/1.1&quot; 200 -
10.5.50.52 - - [28/Apr/2021 08:42:32] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -
</code></pre><p>Le port 5000 &#xE9;tant le port par d&#xE9;faut d&#xE9;finit par Flask, mais qui est changeable avec le param&#xE8;tre <code>flask run --host=0.0.0.0 -p 8000</code>, dans ce cas, le port de Flask sera chang&#xE9; &#xE0; 8000.</p>
<h5 class="mume-header" id="routes">Routes</h5>

<p>Flask fonctionne avec un syst&#xE8;me de routes. Les routes sont &#xE9;crites de la mani&#xE8;re suivante :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&apos;/nom_de_la_route&apos;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">nom_de_la_fonction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Code ...</span>
    <span class="token keyword">return</span> html_a_afficher
</pre><p>Lors de l&apos;acc&#xE8;s &#xE0; une route, le code &#xE0; l&apos;int&#xE9;rieur de la fonction sera ex&#xE9;cut&#xE9;e puis rendra de l&apos;HTML &#xE0; afficher.</p>
<p>On peut aussi r&#xE9;cup&#xE9;rer une valeur depuis la route de la mani&#xE8;re suivante :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&apos;/hello/&lt;name&gt;&apos;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span>param_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">&apos;hello.html&apos;</span><span class="token punctuation">,</span> name<span class="token operator">=</span>param_name<span class="token punctuation">)</span>
</pre><h5 class="mume-header" id="templates">Templates</h5>

<p>Si les routes rendent de l&apos;HTML, c&apos;est que l&apos;on peut injecter des valeurs dans du code HTML pr&#xE9;-&#xE9;cris. Pour ce faire, &#xE0; la racine du projet, il faut cr&#xE9;er un dossier pr&#xE9;cis&#xE9;ment nomm&#xE9; de la sorte : <code>templates</code>. Ce r&#xE9;pertoire contiendra les diff&#xE9;rents templates HTML &#xE0; afficher. Voici comment un fichier de template HTML est &#xE9;crit :</p>
<pre data-role="codeBlock" data-info="HTML" class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hello from Flask<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
{% if name %}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Hello {{ name }}!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
{% else %}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Hello, World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
{% endif %}
</pre><p>Les balises {% ... %} permettent d&apos;&#xE9;crire du code comme des tests et des boucles.</p>
<p>Les balises {{ nom_de_la_variable }} permettent d&apos;injecter des valeurs dans l&apos;HTML dynamiquement.</p>
<p>Depuis le code python, pour pouvoir utiliser des templates, il faut importer <code>render_template</code> comme suit : <code>from flask import render_template</code></p>
<h5 class="mume-header" id="barre-de-navigation">Barre de navigation</h5>

<p>En pr&#xE9;requis, il faut installer les librairies :</p>
<ol>
<li>flask_bootstrap</li>
<li>flask_nav</li>
</ol>
<p>Voici la commande &#xE0; utiliser : <code>sudo pip3 install flask_bootstrap &amp;&amp; sudo pip3 install flask_nav</code></p>
<p>Ensuite, dans le code une fois les libraires import&#xE9;es comme suit :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">from</span> flask_bootstrap <span class="token keyword">import</span> Bootstrap
<span class="token keyword">from</span> flask_nav <span class="token keyword">import</span> Nav
<span class="token keyword">from</span> flask_nav<span class="token punctuation">.</span>elements <span class="token keyword">import</span> <span class="token operator">*</span>
</pre><p>Nous pouvons initialiser notre barre de navigation avec un nom ainsi que leurs routes :</p>
<pre data-role="codeBlock" data-info="python" class="language-python">topbar <span class="token operator">=</span> Navbar<span class="token punctuation">(</span>
    View<span class="token punctuation">(</span><span class="token string">&apos;Accueil&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;home&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    View<span class="token punctuation">(</span><span class="token string">&apos;T&#xE9;l&#xE9;commande&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;control_car&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    View<span class="token punctuation">(</span><span class="token string">&apos;D&#xE9;connexion&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;close_connection&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    View<span class="token punctuation">(</span><span class="token string">&apos;Cr&#xE9;er une connexion&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;create_car&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

nav <span class="token operator">=</span> Nav<span class="token punctuation">(</span><span class="token punctuation">)</span>
nav<span class="token punctuation">.</span>register_element<span class="token punctuation">(</span><span class="token string">&apos;top&apos;</span><span class="token punctuation">,</span> topbar<span class="token punctuation">)</span>


app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
Bootstrap<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
</pre><p>Pour y avoir acc&#xE8;s, on peut l&apos;inclure dans une page HTML de la mani&#xE8;re suivante :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token punctuation">{</span><span class="token operator">%</span> block navbar <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span>nav<span class="token punctuation">.</span>top<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">&apos;top-navbar&apos;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
</pre><h5 class="mume-header" id="formulaires">Formulaires</h5>

<p>Les formulaires avec Flask sont &#xE9;crits en HTML classique :</p>
<pre data-role="codeBlock" data-info="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/route_apres_validation<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>POST ou GET<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input_txt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input_cbx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">checked</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>valider<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input_validation<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</pre><p>Pour r&#xE9;cup&#xE9;rer les informations des diff&#xE9;rents champs du formulaire, voici le code qui permet de les r&#xE9;cup&#xE9;rer :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&apos;/route_apres_validation&apos;</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&apos;GET&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;POST&apos;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">nom_de_fonction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">&apos;POST&apos;</span> <span class="token keyword">and</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">&quot;input_validation&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        valeur <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">&quot;nom_input_html&quot;</span><span class="token punctuation">]</span>
        <span class="token comment"># Traitement ...</span>
    <span class="token keyword">return</span> html_a_afficher
</pre><p>Dans le param&#xE8;tre <code>methods</code> de la route, le param&#xE8;tre GET est celui de base, mais peut &#xEA;tre chang&#xE9; par POST.</p>
<h5 class="mume-header" id="javascript-ajax">Javascript / AJAX</h5>

<p>&#xC9;tant donn&#xE9; que Flask nous permet d&apos;&#xE9;crire des pages HTML qui seront ins&#xE9;r&#xE9;s dans la page lors de l&apos;appel (voir la section regroupant les Templates), cela veut dire que nous pouvons &#xE9;crire du javascript &#xE0; l&apos;aide des balises <code>&lt;script type=text/javascript&gt;&lt;/script&gt;</code>. Pour le cas d&apos;AJAX, il suffit de t&#xE9;l&#xE9;charger la librairie JQuery afin d&apos;y avoir acc&#xE8;s ou en utilisant le CDN <code>&lt;script src=&quot;https://code.jquery.com/jquery-3.6.0.min.js&quot; integrity=&quot;sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</code>.</p>
<p>&#xC0; noter, que l&apos;unique diff&#xE9;rence entre ces deux mani&#xE8;res d&apos;avoir acc&#xE8;s &#xE0; JQuery, est que l&apos;un est accessible en ligne et l&apos;autre sur la machine donc la rapidit&#xE9; d&apos;ex&#xE9;cution, car en utilisant la version en ligne, en fonction du d&#xE9;bit de la connexion, il peut y avoir de la latence.</p>
<p>Pour mettre en place de l&apos;AJAX, il faut dans des balises script sur l&apos;une des pages HTML pr&#xE9;sentent dans le r&#xE9;pertoire <code>templates</code>. La m&#xE9;thode <code>serialize()</code>, permet de r&#xE9;cup&#xE9;rer de s&#xE9;rialiser les donn&#xE9;es pr&#xE9;sentes dans le formulaire HTML.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token method function property-access">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token operator">:</span> <span class="token string">&apos;/bg_processing_car/&apos;</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&apos;form&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">&apos;POST&apos;</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;action performed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</pre><p>Et dans le code python, voici comment on r&#xE9;cup&#xE8;re et traite les donn&#xE9;es :</p>
<p>On peut consid&#xE9;rer les donn&#xE9;es envoy&#xE9;es par l&apos;appel AJAX comme ceci :</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    rngMove <span class="token operator">:</span> <span class="token number">75</span><span class="token punctuation">,</span>
    rngRotationAngle <span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</pre><p>Et on les r&#xE9;cup&#xE8;rent exactement comme pour un formulaire classique :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/bg_processing_car/&quot;</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">bg_process_car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Process the values passed by Javascript&quot;&quot;&quot;</span>
    automatic_mode <span class="token operator">=</span> MODE_OFF
    move_speed <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">&quot;rngMove&quot;</span><span class="token punctuation">]</span>
    angle_rotation <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">&quot;rngRotationAngle&quot;</span><span class="token punctuation">]</span>
    car <span class="token operator">=</span> CarController<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Reverse the result because it returns True if there isn&apos;t a ground below</span>
    grounded <span class="token operator">=</span> <span class="token keyword">not</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>GPIO_FLYING_FISH_FRONT_RIGHT<span class="token punctuation">)</span>
    car<span class="token punctuation">.</span>move<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>move_speed<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>angle_rotation<span class="token punctuation">)</span><span class="token punctuation">,</span> grounded<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span>
        <span class="token string">&quot;form_remote_car.html&quot;</span><span class="token punctuation">,</span>
        mode<span class="token operator">=</span>automatic_mode<span class="token punctuation">,</span>
        speed<span class="token operator">=</span>move_speed<span class="token punctuation">,</span>
        angle<span class="token operator">=</span>angle_rotation<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</pre><h2 class="mume-header" id="bluetooth">Bluetooth</h2>

<h3 class="mume-header" id="quest-ce-que-le-bluetooth">Qu&apos;est-ce que le bluetooth ?</h3>

<p>Le bluetooth est une norme de communication &#xE0; courte distance utilisant des ondes radios sur la bande de fr&#xE9;quence 2,4GHz. Ce qui permet d&apos;&#xE9;changer des donn&#xE9;es dans les deux sens en <em>peer-to-peer</em> dans un picor&#xE9;seau.</p>
<p><img src="./images/bluetooth/bluetooth_logo.png" alt="Logo du Bluetooth" title="Logo du Bluetooth"></p>
<p>Un picor&#xE9;seau (en anglais piconet) est un mini-r&#xE9;seau qui se cr&#xE9;e de mani&#xE8;re instantan&#xE9;e et automatique quand plusieurs p&#xE9;riph&#xE9;riques Bluetooth sont dans un m&#xEA;me rayon.</p>
<h4 class="mume-header" id="comment-est-il-structur%C3%A9">Comment est-il structur&#xE9; ?</h4>

<p>Quand on parle de bluetooth, au niveau des protocoles, on peut parler de relations <em>Ma&#xEE;tres</em> et d&apos;<em>Esclaves</em>. Le <em>Ma&#xEE;tre</em> Bluetooth est celui qui peut initier une connexion avec un p&#xE9;riph&#xE9;rique (ou <em>Esclave</em>), cependant une fois les appareils connect&#xE9;s, le <em>Ma&#xEE;tre</em> et l&apos;<em>Esclave</em> peuvent &#xE9;changer des informations sans restriction (en fonction de la limitation de l&apos;application).</p>
<p><img src="./images/bluetooth/bluetooth_picoreseau.png" alt="Sch&#xE9;ma d&apos;un picor&#xE9;seau (Piconet en anglais)" title="Sch&#xE9;ma d&apos;un picor&#xE9;seau (Piconet en anglais)"></p>
<p>Les relations <em>Ma&#xEE;tre</em>-<em>Esclave</em> sont g&#xE9;r&#xE9;es par le gestionnaire de liaison. Il impl&#xE9;mente le protocole L2CAP (de l&apos;anglais <em>Logical Link Control and Adaptation Protocol</em>) et le g&#xE8;re (cr&#xE9;ation, destruction de canaux). Il impl&#xE9;mente aussi les m&#xE9;canismes de s&#xE9;curit&#xE9; comme :</p>
<ul>
<li>l&apos;authentification</li>
<li>l&apos;appairage (l&apos;association)</li>
<li>la cr&#xE9;ation et la modification des cl&#xE9;s</li>
<li>et le chiffrement</li>
</ul>
<h4 class="mume-header" id="s%C3%A9curit%C3%A9">S&#xE9;curit&#xE9;</h4>

<p>Il existe 3 modes de s&#xE9;curit&#xE9; :</p>
<ul>
<li>Mode 1
<ul>
<li>Non s&#xE9;curis&#xE9; pour toutes op&#xE9;rations</li>
<li>Peut uniquement communiquer avec des appareils du m&#xEA;me mode</li>
</ul>
</li>
<li>Mode 2
<ul>
<li>Fournit un niveau de s&#xE9;curit&#xE9; &#xE0; la couche application apr&#xE8;s l&apos;&#xE9;tablissement d&apos;une liaison avec un autre dispositif</li>
</ul>
</li>
<li>Mode 3
<ul>
<li>Fournit un niveau de s&#xE9;curit&#xE9; avant l&apos;&#xE9;tablissement du canal de communication</li>
<li>Chiffrement s&#xE9;curis&#xE9; au niveau de la liaison avec autre dispositif</li>
</ul>
</li>
</ul>
<p>&#xC0; noter, si un service effectue une demande de connexion, le mode de s&#xE9;curit&#xE9; les plus haut sera celui utilis&#xE9; afin de traiter la demande toute en s&apos;assurant de la s&#xE9;curit&#xE9; relative aux diff&#xE9;rents modes.</p>
<p>Le bluetooth est divis&#xE9; en deux parties :</p>
<ol>
<li>La couche contr&#xF4;leur impl&#xE9;mentant la partie mat&#xE9;rielle</li>
<li>La couche h&#xF4;te impl&#xE9;mentant la partie logicielle.</li>
</ol>
<p>L&apos;&#xE9;mission et la r&#xE9;ception de signaux radio sont possible gr&#xE2;ce &#xE0; un module RF (RadioFrequency).</p>
<p>L&apos;interface host-controller (HCI) fait la liaison entre la couche h&#xF4;te et la couche contr&#xF4;leur en assurant le transfert des &#xE9;v&#xE9;nements et des paquets de donn&#xE9;es. Cette interface assure le transfert d&#x2019;information pour que la couche h&#xF4;te puisse d&#xE9;couvrir, ajouter et g&#xE9;rer les appareils dans un picor&#xE9;seau.</p>
<p>Chaque paquet poss&#xE8;de un champ header permettant de distinguer le picor&#xE9;seau de l&#x2019;appareil des autres picor&#xE9;seaux. Voici le format d&apos;un paquet :</p>
<table>
<thead>
<tr>
<th>Champ</th>
<th style="text-align:center">Header</th>
<th style="text-align:center">Access Address</th>
<th style="text-align:center">Protocol Data Unit (PDU)</th>
<th style="text-align:center">Cyclic redundancy Check (CRC)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Taille en bits</td>
<td style="text-align:center">8</td>
<td style="text-align:center">32</td>
<td style="text-align:center">de 2 &#xE0; 39</td>
<td style="text-align:center">24</td>
</tr>
</tbody>
</table>
<p>Le PDU est une unit&#xE9; de mesure des informations &#xE9;chang&#xE9;es dans un r&#xE9;seau informatique. Appliqu&#xE9; aux couches du mod&#xE8;le OSI, le PDU de :</p>
<ul>
<li>La couche physique est le bit.</li>
<li>La couche liaison est la trame.</li>
<li>La couche r&#xE9;seau est le paquet.</li>
<li>La couche transport est le segment pour TCP, et le datagramme pour UDP.</li>
<li>Les couches application, pr&#xE9;sentation et session sont les donn&#xE9;es.</li>
</ul>
<p>Le Cyclic Redundancy Check, autrement appel&#xE9; contr&#xF4;le de redondance cyclique, permet de d&#xE9;tecter des erreurs de transmission ou de transfert par ajout, combinaison et comparaison de donn&#xE9;es redondantes, obtenues gr&#xE2;ce &#xE0; une proc&#xE9;dure de hachage. Cette m&#xE9;thode est comparable au checksum, mais ce dernier est plus &#xE9;labor&#xE9;.</p>
<p>Les paquets re&#xE7;us par le HCI sont trait&#xE9;s par le protocole L2CAP. Il assure le transport des paquets vers les couches sup&#xE9;rieures du mod&#xE8;le OSI, la segmentation et le r&#xE9;-assemblage des paquets.</p>
<p>La couche de liaison est d&#xE9;finie dans les syst&#xE8;mes bluetooth comme la couche assurant le transport des paquets entre les appareils d&#x2019;un m&#xEA;me picor&#xE9;seau &#xE0; travers plusieurs canaux :</p>
<p><img src="./images/bluetooth/architecture_bluetooth.jpg" alt="Architecture du Bluetooth" title="Architecture du Bluetooth"></p>
<ul>
<li>Basic channel : Canal pour la communication entre deux appareils</li>
<li>Adapted piconet channel : Canal pour la communication dans le picor&#xE9;seau</li>
<li>Inquiry scan : Canal pour l&apos;acquisition des appareils bluetooth aux alentours</li>
<li>Page scan : Canal pour la connexion avec un nouvel appareil</li>
</ul>
<h4 class="mume-header" id="quest-ce-que-generic-access-profile">Qu&apos;est-ce que Generic Access Profile</h4>

<p>Generic Access Profile (GAP), est responsable de la connexion. De plus, il g&#xE8;re aussi :</p>
<ul>
<li>les modes d&apos;acc&#xE8;s</li>
<li>les proc&#xE9;dures du dispositif</li>
<li>la d&#xE9;couverte du dispositif</li>
<li>l&apos;&#xE9;tablissement et la fin de la liaison</li>
<li>le lancement des fonctions de s&#xE9;curit&#xE9;</li>
<li>la configuration du dispositif.</li>
</ul>
<p><img src="./images/bluetooth/diag_etat_gap.png" alt="Diagramme d&apos;&#xE9;tats du profile GAP" title="Diagramme d&apos;&#xE9;tats du profile GAP"></p>
<ul>
<li>Veille : le dispositif est dans l&apos;&#xE9;tat initial de veille lors de la r&#xE9;initialisation.</li>
<li>Annonce : Le dispositif envoie un message d&apos;annonce avec des donn&#xE9;es sp&#xE9;cifiques pour faire savoir aux dispositifs initiateurs qu&apos;il est un dispositif connectable (cette annonce contient l&apos;adresse du dispositif et peut contenir des donn&#xE9;es suppl&#xE9;mentaires telles que le nom du dispositif).</li>
<li>Scan : Lorsqu&apos;il re&#xE7;oit l&apos;annonce, le dispositif de scan envoie une demande de scan &#xE0; l&apos;annonceur qui r&#xE9;pondra par une r&#xE9;ponse d&apos;analyse. Cette m&#xE9;thode est appel&#xE9;e d&#xE9;couverte du dispositif. Le dispositif d&apos;analyse conna&#xEE;t le dispositif ayant &#xE9;mis l&apos;annonce et peut &#xE9;tablir une connexion avec lui.</li>
<li>Initiation : Lors de l&apos;initialisation, l&apos;initiateur doit sp&#xE9;cifier une adresse de dispositif homologue &#xE0; laquelle se connecter. S&apos;il re&#xE7;oit une annonce correspondant &#xE0; l&apos;adresse du dispositif homologue, le dispositif initiateur envoie une demande de connexion avec les param&#xE8;tres disponible ci-dessous :
<ul>
<li>Intervale de connexion (entre 7.5 et 3200 ms)</li>
<li>La latence de l&apos;esclave</li>
<li>D&#xE9;lai de supervision (entre 10 et 3200 ms)</li>
</ul>
</li>
<li>Esclave/Ma&#xEE;tre : Lorsqu&apos;une connexion est &#xE9;tablie, le dispositif fonctionne comme un esclave s&apos;il s&apos;agit de l&apos;annonceur sinon comme un ma&#xEE;tre s&apos;il s&apos;agit de l&apos;initiateur.</li>
</ul>
<h5 class="mume-header" id="quest-ce-que-generic-attribute-profile">Qu&apos;est-ce que Generic Attribute Profile</h5>

<p>Generic Attribute Profile (GATT), est responsable de la communications de donn&#xE9;es entre les appareils connect&#xE9;s. Il est structur&#xE9; en <em>Services</em> et <em>Characteristics</em> comme ci-dessous :</p>
<p><img src="./images/gatt/gatt_comparison_between_hierarchy_and_EFR.png" alt="Architecture GATT" title="Architecture GATT"></p>
<p>Les attributs sont group&#xE9;s en <em>services</em>, chaque <em>services</em> peut contenir 0 ou + <em>characteristics</em>. Ces derni&#xE8;res peuvent avoir de 0 &#xE0; + <em>descriptors</em>.</p>
<ul>
<li>GATT Server : Technic Hub</li>
<li>Service : Generic Attribute
<ul>
<li>Characteristic : Service Change</li>
</ul>
</li>
<li>Service : Generic Access
<ul>
<li>Characteristic : Device Name</li>
<li>Characteristic : Appearance</li>
<li>Characteristic : Peripheral Preferred Connection Parameters</li>
</ul>
</li>
<li>Service : LegoTechnicHub (renomm&#xE9;e car de base l&apos;application affichait Unknown ervice)
<ul>
<li>Characteristic : Unknown Charateristic</li>
</ul>
</li>
</ul>
<p>Pour avoir acc&#xE8;s &#xE0; ces informations, j&apos;ai utilis&#xE9; l&apos;application EFRConnect disponible sur le playstore.<br>
J&apos;ai lanc&#xE9; un scan depuis le Raspberry Pi, voici les informations qui ont &#xE9;t&#xE9; retourn&#xE9;es :</p>
<pre data-role="codeBlock" data-info class="language-"><code>[NEW] Device 90:84:2B:50:36:43 Technic Hub
[CHG] Device 90:84:2B:50:36:43 RSSI: -58
[CHG] Device 90:84:2B:50:36:43 TxPower: 0
[CHG] Device 90:84:2B:50:36:43 ManufacturerData Key: 0x0397
[CHG] Device 90:84:2B:50:36:43 ManufacturerData Value:
  00 80 06 00 61 00                                ....a.
</code></pre><p>Par la suite, j&apos;ai lanc&#xE9; un scan depuis l&apos;application afin de comparer les donn&#xE9;es, voici les informations que l&apos;application m&apos;a retourn&#xE9;e concernant le Technic Hub :</p>
<ul>
<li>
<p>Flags : <code>0x06: LE General Discoverable Mode, BR/EDR Not Supported</code></p>
</li>
<li>
<p>Complete list of 128-bit service class UUIDs : <code>00001624-1212-EFDE-1623-785FEABCD123</code></p>
</li>
<li>
<p>Manufacturer Data :</p>
<ol>
<li>Company Code : <code>0x0397</code></li>
<li>Data : <code>0x008006004100</code></li>
<li>Slave connection interval range : <code>20.0ms</code></li>
<li>Tx power level: <code>0 dBm</code></li>
<li>Complete local name : <code>Technic Hub</code></li>
</ol>
</li>
<li>
<p>Generic attribute : <code>0x1801</code></p>
<ol>
<li>UUID : <code>0x2A05</code></li>
<li>Descriptor : <em>champs vide</em></li>
<li>Client characteristic configuration : <code>0x2902</code></li>
</ol>
</li>
<li>
<p>Generic access :</p>
<ol>
<li>Device name : <code>0x1800</code></li>
<li>Appearance : <code>0x2A01</code></li>
<li>Peripheral preffered connection parameters : <code>0x2A04</code></li>
</ol>
</li>
<li>
<p><em>Unknown Service</em> :</p>
<ol>
<li>UUID : <code>00001624-1212-EFDE-1623-785FEABCD123</code></li>
<li>Descriptor : <em>champs vide</em></li>
<li>Client characteristic configuration : <code>0x2902</code></li>
<li>Value : <code>05 00 04 03 00 2E 00 00 10 00 00 00 10 00 00 00 00 00 00 00</code></li>
</ol>
</li>
</ul>
<h3 class="mume-header" id="tchat-en-bluetooth">T&apos;chat en bluetooth</h3>

<h4 class="mume-header" id="mise-en-place-9">Mise en place</h4>

<p>Il faut que les 2 Raspberry Pi soient en mode &quot;D&#xE9;couvrable&quot; activable ici :</p>
<p><img src="./images/raspberrys/rsp_make_discoverable.png" alt="Rendre d&#xE9;couvrable le Raspberry Pi" title="Rendre d&#xE9;couvrable le Raspberry Pi">.</p>
<p>Il faut ensuite effectuer un scan des appareils si nous ne connaissons pas le nom d&apos;h&#xF4;te de l&apos;autre Raspberry Pi. Le script doit &#xEA;tre pr&#xE9;sent sur les deux Raspberry Pi afin de pouvoir &#xE9;couter, recevoir ainsi qu&apos;envoyer des messages. La machine h&#xF4;te, moi dans ce contexte, doit &#xEA;tre en mode MODE_SEND tandis que l&apos;autre en mode MODE_RECEIVE.</p>
<h4 class="mume-header" id="utilisation-8">Utilisation</h4>

<p>Le code fonctionne de la mani&#xE8;re suivante. La machine h&#xF4;te va en premier temps lancer le scan &#xE0; la recherche de l&apos;appareil nomm&#xE9; <code>morenoPi42</code>.<br>
<img src="./images/raspberrys/rsp_scan_bluetooth.png" alt="Scan bluetooth des environs" title="Scan bluetooth des environs"></p>
<p>Une fois l&apos;appareil trouv&#xE9;, je m&apos;y appareille, puis lui envoie le premier message.<br>
<img src="./images/raspberrys/rsp_send_data_to_another_rsp.png" alt="Transf&#xE8;re de donn&#xE9;es entre les 2 Raspberry Pi 4" title="Transf&#xE8;re de donn&#xE9;es entre les 2 Raspberry Pi 4"></p>
<p>Le mode actuel, change et je deviens la machine qui &#xE9;coute le port sp&#xE9;cifi&#xE9; en attendant un message.</p>
<p><img src="./images/bluetooth/tchat.png" alt="T&apos;chat en bluetooth" title="T&apos;chat en bluetooth"></p>
<p><img src="./images/bluetooth/diag_seq_tchat_bluetooth.png" alt="Diagramme de s&#xE9;quence du T&apos;chat en bluetooth" title="Diagramme de s&#xE9;quence du T&apos;chat en bluetooth"></p>
<h3 class="mume-header" id="remote-gpio">Remote GPIO</h3>

<p>Le <a href="######Pi-4">GPIO</a> nous permet d&apos;acc&#xE9;der aux entr&#xE9;es / sorties des appareils connect&#xE9;s au Raspberry Pi.</p>
<h4 class="mume-header" id="mise-en-place-10">Mise en place</h4>

<p>Pour pouvoir utiliser le Remote GPIO, il faut tout d&apos;abord l&apos;activer dans l&apos;interface de configuration pr&#xE9;sente ci-dessous :</p>
<p><img src="./images/raspberrys/rsp_config-rsp.png" alt="Diagramme de s&#xE9;quence du T&apos;chat en bluetooth" title="Diagramme de s&#xE9;quence du T&apos;chat en bluetooth"></p>
<p>Puis dans la fen&#xEA;tre pr&#xE9;sente, tout en bas, cliquer sur <em>Activ&#xE9;</em> :</p>
<p><img src="./images/raspberrys/rsp_config-rsp_remote-gpio.png" alt="Diagramme de s&#xE9;quence du T&apos;chat en bluetooth" title="Diagramme de s&#xE9;quence du T&apos;chat en bluetooth"></p>
<p>Une fois que la configuration des diff&#xE9;rents Raspberry Pi est faite, il ne manque plus qu&apos;&#xE0; t&#xE9;l&#xE9;charger GPIO Zero, une librairie nous donnant acc&#xE8;s &#xE0; la gestion des diff&#xE9;rentes pins :<br>
<code>sudo pip3 install gpiozero</code></p>
<p>Ensuite nous aurons besoin de Pi GPIO :<br>
<code>sudo apt install pigpio</code></p>
<p>Une fois install&#xE9;, il faut lancer le service PiGPIO : <code>sudo pigpiod</code> sur la machine qui sera contr&#xF4;l&#xE9;e &#xE0; distance.</p>
<h4 class="mume-header" id="utilisation-9">Utilisation</h4>

<p>Pour pouvoir se connecter au Raspberry Pi, il faut conna&#xEE;tre son adresse IP. Une fois connue, voici comment &#xE9;tablir une connexion :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">import</span> gpiozero
<span class="token keyword">from</span> gpiozero <span class="token keyword">import</span> LED<span class="token punctuation">,</span>Button
<span class="token keyword">from</span> gpiozero<span class="token punctuation">.</span>pins<span class="token punctuation">.</span>pigpio <span class="token keyword">import</span> PiGPIOFactory
<span class="token keyword">from</span> signal <span class="token keyword">import</span> pause

factory <span class="token operator">=</span> PiGPIOFactory<span class="token punctuation">(</span><span class="token string">&apos;10.5.50.42&apos;</span><span class="token punctuation">)</span>

btn <span class="token operator">=</span> Button<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># local RPi.GPIO pin</span>
led <span class="token operator">=</span> LED<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> pin_factory<span class="token operator">=</span>factory<span class="token punctuation">)</span> <span class="token comment"># remote pin</span>

btn<span class="token punctuation">.</span>wait_for_press<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;button pressed !&quot;</span><span class="token punctuation">)</span>
led<span class="token punctuation">.</span>off<span class="token punctuation">(</span><span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>Dans notre cas, avec M. Moreno interpr&#xE9;tant le Raspberry Pi <em>principal</em> qui int&#xE9;ragirait avec les pins de mon Raspberry Pi.</p>
<p><img src="./images/breadboard_moreno.jpeg" alt="breadboard de M. Moreno" title="breadboard de M. Moreno"></p>
<ul>
<li>Le bouton est connect&#xE9; au GPIO 2, donc la pin 3</li>
</ul>
<p><img src="./images/breadboard_ackermann.jpeg" alt="breadboard de M. Ackermann" title="breadboard de M. Ackermann"></p>
<ul>
<li>La led est connect&#xE9;e au GPIO 17, donc la pin 11</li>
</ul>
<p><img src="./images/raspberrys/GPIO-connected_pin_remote-gpio.png" alt="breadboard de M. Ackermann" title="breadboard de M. Ackermann"></p>
<h2 class="mume-header" id="matplotlib">Matplotlib</h2>

<p>Matplotlib est une librairie compl&#xE8;te permettant la cr&#xE9;ation de statistiques sur un large panel de graphiques utilisable en Python.</p>
<h4 class="mume-header" id="mise-en-place-11">Mise en place</h4>

<p>Il faut d&apos;abord installer Matplotlib avec la commande <code>sudo apt-get install python3-matplotlib</code></p>
<h4 class="mume-header" id="utilisation-10">Utilisation</h4>

<p>Sur le site officiel, il y a cet exemple que j&apos;ai repris pour en faire l&apos;affichage de mon radar 360&#xB0; :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt


<span class="token comment"># Fixing random state for reproducibility</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">19680801</span><span class="token punctuation">)</span>

<span class="token comment"># Compute areas and colors</span>
N <span class="token operator">=</span> <span class="token number">150</span>
r <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>N<span class="token punctuation">)</span>
theta <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>pi <span class="token operator">*</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>N<span class="token punctuation">)</span>
area <span class="token operator">=</span> <span class="token number">200</span> <span class="token operator">*</span> r<span class="token operator">**</span><span class="token number">2</span>
colors <span class="token operator">=</span> theta

plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span>projection<span class="token operator">=</span><span class="token string">&apos;polar&apos;</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>theta<span class="token punctuation">,</span> r<span class="token punctuation">,</span> c<span class="token operator">=</span>colors<span class="token punctuation">,</span> s<span class="token operator">=</span>area<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">&apos;hsv&apos;</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.75</span><span class="token punctuation">)</span>

</pre><p>Voici ce que l&apos;exemple <a href="https://matplotlib.org/stable/gallery/pie_and_polar_charts/polar_scatter.html#sphx-glr-gallery-pie-and-polar-charts-polar-scatter-py">ici</a> pr&#xE9;sent donne :</p>
<p><img src="./images/test_graph.png" alt="Affichage du graphique g&#xE9;n&#xE9;r&#xE9; par le code d&apos;exemple" title="Affichage du graphique g&#xE9;n&#xE9;r&#xE9; par le code d&apos;exemple"></p>
<p>Voici le code cr&#xE9;ant le graphique que j&apos;utilise pour afficher les points :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">def</span> <span class="token function">make_chart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Will process the chart and save it into a png
    &quot;&quot;&quot;</span>
    <span class="token keyword">global</span> rows
    area <span class="token operator">=</span> <span class="token number">5</span>
    colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># near -&gt; mid -&gt; far</span>
    cmap_name <span class="token operator">=</span> <span class="token string">&quot;distance_warning&quot;</span>
    cmap <span class="token operator">=</span> matplotlib<span class="token punctuation">.</span>colors<span class="token punctuation">.</span>LinearSegmentedColormap<span class="token punctuation">.</span>from_list<span class="token punctuation">(</span>cmap_name<span class="token punctuation">,</span> colors<span class="token punctuation">)</span>
    data_x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    data_y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    angle <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># Create the colors I need, values between 0 and 1 for (r, g, b)</span>
    <span class="token comment"># add angle in radian and his value in two array x and y</span>
    <span class="token keyword">for</span> distance <span class="token keyword">in</span> rows<span class="token punctuation">:</span>
        data_x<span class="token punctuation">.</span>append<span class="token punctuation">(</span>math<span class="token punctuation">.</span>radians<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span>
        data_y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>
        angle <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token comment"># set the projection to polar</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span>projection<span class="token operator">=</span><span class="token string">&quot;polar&quot;</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>data_x<span class="token punctuation">,</span> data_y<span class="token punctuation">,</span> s<span class="token operator">=</span>area<span class="token punctuation">,</span> c<span class="token operator">=</span>data_y<span class="token punctuation">,</span> cmap<span class="token operator">=</span>cmap<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>constants<span class="token punctuation">.</span>CHART_PATH <span class="token operator">+</span> constants<span class="token punctuation">.</span>CHART_NAME<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>clf<span class="token punctuation">(</span><span class="token punctuation">)</span>

</pre><p><img src="./images/graph_warning_colors.png" alt="Affichage du graphique g&#xE9;n&#xE9;r&#xE9; avec les couleurs pr&#xE9;venant le danger par rapport &#xE0; un obstacle" title="Affichage du graphique g&#xE9;n&#xE9;r&#xE9; avec les couleurs pr&#xE9;venant le danger par rapport &#xE0; un obstacle"></p>
<p>Voici un exemple du scanner en un quasi-temps r&#xE9;el :</p>
<p><img src="./images/radar_animation.gif" alt="Affichage des donn&#xE9;es en temps r&#xE9;el" title="Affichage des donn&#xE9;es en temps r&#xE9;el"></p>
<p>Ici, on parle de quasi-temps r&#xE9;el, car comme vu dans le section parlant du Lidar, on traite les donn&#xE9;es &#xE9;mises par l&apos;API en temps r&#xE9;el de mani&#xE8;re asynchrone, mais le graphique &#xE9;tant une image enregistr&#xE9;e, le temps d&apos;&#xE9;criture de l&apos;image ainsi que le temps de lecture fait que les images s&apos;accumulent et que par cons&#xE9;quent l&apos;image gagne du d&#xE9;lai.</p>
<h2 class="mume-header" id="raspap">RaspAP</h2>

<p>RaspAP est une application permettant de mettre en place un point d&apos;acc&#xE8;s WiFi avec un raspberry pi facilement.</p>
<h3 class="mume-header" id="mise-en-place-12">Mise en place</h3>

<p>Par pr&#xE9;caution, il est n&#xE9;cessaire de mettre son raspberry pi avec la commande <code>sudo apt update &amp;&amp; sudo apt full-upgrade</code>.</p>
<p>Ensuite, il faut t&#xE9;l&#xE9;charger le code du repository Git avec la commande suivante : <code>wget -q https://git.io/voEUQ -O /tmp/raspap &amp;&amp; bash /tmp/raspap</code>. Durant toute l&apos;installation, il faut tout accepter, &#xE0; moins d&apos;avoir une bonne raison, mais dans ce cas &#xE7;a ne l&apos;est pas.</p>
<p>Apr&#xE8;s l&apos;installation, il faut red&#xE9;marrer le raspberry pi. Une fois red&#xE9;marr&#xE9;, le raspberry pi devrait avec cette adresse IP : <code>10.3.141.1</code>. Pour pouvois acc&#xE8;s &#xE0; cette informations, ouvrez un terminal et ex&#xE9;cuter la commande : <code>ip a</code> ou <code>ifconfig</code>. Normalement vous devriez voir un section nomm&#xE9;e <code>Wlan0</code>.</p>
<h3 class="mume-header" id="utilisation-11">Utilisation</h3>

<p>Une fois RaspAP install&#xE9;, vous pouvez vous rendre sur <code>10.3.141.1</code> dans un navigateur web afin d&apos;avoir acc&#xE8;s au tableau de bord de RaspAP :</p>
<p>Pour se connecter, une fen&#xEA;tre comme celle ci-dessous appara&#xEE;tra. Les identifiants par d&#xE9;faut sont <code>admin</code> pour le nom d&apos;utilisateur et <code>secret</code> comme mot de passe.</p>
<p><img src="./images/raspap/connection.png" alt="Page de connexion pour RaspAP" title="Page de connexion pour RaspAP"></p>
<p>Pour pouvoir se connecter au WiFi (toujours avec les valeurs par d&#xE9;faut) le nom du r&#xE9;seau est : <code>raspi-webgui</code> avec pour mot de passe <code>ChangeMe</code>. Vous pourrez le voir dans les appareils permettant d&apos;acc&#xE9;der &#xE0; des r&#xE9;seaux WiFi.</p>
<p>Une fois connect&#xE9;, vous arriverez sur la page de tableau de bord de RaspAP :</p>
<p><img src="./images/raspap/ui_dashboard.png" alt="Tableau de bord de RaspAP" title="Tableau de bord de RaspAP"></p>
<p>Depuis l&apos;interface utilisateur, il faut cliquer sur <code>Hotspot</code> pour pouvoir changer le nom du r&#xE9;seau <code>SSID</code>.</p>
<p><img src="./images/raspap/ui_dashboard_hotspot.png" alt="Section Hotsport de RaspAP" title="Section Hotsport de RaspAP"></p>
<p>Une fois sur la page de configuration du Hotspot, il faut changer le SSID du r&#xE9;seau par le nom que vous souhaiteriez qu&apos;il adopte. Dans mon cas je l&apos;ai chang&#xE9; &#xE0; <code>rps4_access_point</code> :</p>
<p><img src="./images/raspap/ui_dashboard_hotspot_security_ssid.png" alt="Section Hotsport de RaspAP" title="Section Hotsport de RaspAP"></p>
<p>Pour changer le mot de passe <code>Pre Shared Key</code>, il faut aller dans l&apos;onglet <code>Security</code>, remplir les informations que vous souhaitez utiliser pour vous connecter au r&#xE9;seau WiFi. :</p>
<p><img src="./images/raspap/ui_dashboard_hotspot_security_psk.png" alt="Section Hotsport de RaspAP" title="Section Hotsport de RaspAP"></p>
<p>Pour terminer, cliquez sur <code>Restart hotspot</code> en bas &#xE0; droite de la page.</p>
<h1 class="mume-header" id="manuel-technique">Manuel technique</h1>

<p>Dans cette rubrique, nous allons voir comment les divers &#xE9;l&#xE9;ments utilis&#xE9;s dans ce projet ont &#xE9;t&#xE9; mis en place.</p>
<h2 class="mume-header" id="plan-r%C3%A9seau">Plan r&#xE9;seau</h2>

<p>&#xC9;tant donn&#xE9; que les divers &#xE9;l&#xE9;ments communiquent par le WiFi, ils doivent donc avoir des adresses IP. Dans mon cas, j&apos;ai choisis d&apos;utiliser des adresses IP statiques. Tous les Raspberry Pi 0 WiFi sont connect&#xE9;s sur le point d&apos;acc&#xE8;s qu&apos;est le Raspberry Pi 4. Pour comprendre comment le Raspberry Pi 4 a &#xE9;t&#xE9; transformer en point d&apos;acc&#xE8;s, veuillez lire la <a href="##RaspAP">section parlant de la mise en place de RaspAP</a></p>
<h2 class="mume-header" id="branchements">Branchements</h2>

<h3 class="mume-header" id="alimentation-g%C3%A9n%C3%A9rale">Alimentation g&#xE9;n&#xE9;rale</h3>

<p>Pour l&apos;alimentation g&#xE9;n&#xE9;rale, j&apos;ai pris 2 anciens c&#xE2;bles USB que j&apos;ai coup&#xE9; et d&#xE9;nud&#xE9; afin de r&#xE9;cup&#xE9;rer l&apos;alimentation (Le VCC et le GND). Ces deux c&#xE2;bles ont ensuite &#xE9;t&#xE9; soud&#xE9;s sur les pins de la plaquette.</p>
<p>&#xC0; la base, la plaquette ressemblait &#xE0; ceci :<br>
<img src="./images/branchements/plaquette_pin_alimentation_generale.jpg" alt="Plaquette et pins utilis&#xE9;s afin de cr&#xE9;er le syst&#xE8;me d&apos;alimentation g&#xE9;n&#xE9;rale" title="Plaquette et pins utilis&#xE9;s afin de cr&#xE9;er le syst&#xE8;me d&apos;alimentation g&#xE9;n&#xE9;rale"></p>
<p>Pour ensuite &#xEA;tre soud&#xE9; de la sorte :</p>
<p><img src="./images/branchements/alimentation_vcc_gnd_usb_1.jpg" alt="Syst&#xE8;me d&apos;alimentation g&#xE9;n&#xE9;rale" title="Syst&#xE8;me d&apos;alimentation g&#xE9;n&#xE9;rale"></p>
<p><img src="./images/branchements/alimentation_vcc_gnd_usb_2.jpg" alt="Syst&#xE8;me d&apos;alimentation g&#xE9;n&#xE9;rale" title="Syst&#xE8;me d&apos;alimentation g&#xE9;n&#xE9;rale"></p>
<p>Le courant est soud&#xE9; sur la pin de droite tandis que la terre sur la pin de gauche. Ce processus a &#xE9;t&#xE9; r&#xE9;p&#xE9;t&#xE9; 2 fois car il y a du sorties pr&#xE9;sentes sur la batterie externe.</p>
<p>Les c&#xE2;bles USB sont branch&#xE9;s dans les ports Output 1 et 2 de la batterie externe comme ceci :</p>
<p><img src="./images/branchements/USB_alimentation_vcc_gnd.jpg" alt="Courant de l&apos;alimentation g&#xE9;n&#xE9;rale" title="Courant de l&apos;alimentation g&#xE9;n&#xE9;rale"></p>
<p>Il est important de noter, que chaque composant est branch&#xE9; &#xE0; l&apos;alimentation g&#xE9;n&#xE9;rale de la sorte :</p>
<p><img src="./images/branchements/alimentation_vcc_gnd.jpg" alt="Branchement des composant sur l&apos;alimentation g&#xE9;n&#xE9;rale" title="Branchement des composant sur l&apos;alimentation g&#xE9;n&#xE9;rale"></p>
<p>Par cons&#xE9;quent sur cet exemple, les c&#xE2;bles rouges, blancs et violets sont branch&#xE9;s sur le courant et les c&#xE2;bles noirs, gris et bruns sont branch&#xE9;s sur la terre.</p>
<h3 class="mume-header" id="raspberry-pi-4">Raspberry Pi 4</h3>

<p>De base, le Raspberry Pi 4 &#xE9;tait branch&#xE9; &#xE0; l&apos;alimentation g&#xE9;n&#xE9;rale et &#xE9;tait aliment&#xE9; par les pins 4 et 6 du <a href="######Pi-4">GPIO</a>, mais apr&#xE8;s quelque tests, j&apos;ai pu me rendre compte que certain Raspberry Pi 0 WiFi branch&#xE9;s au syst&#xE8;me d&apos;alimentation g&#xE9;n&#xE9;rale n&apos;avaient pas assez de courant et ne faisait que de red&#xE9;marrer en boucle. C&apos;est pourquoi apr&#xE8;s r&#xE9;flexion, j&apos;ai branch&#xE9; le Raspberry Pi 4 sur la batterie externe en USB-C comme ceci :</p>
<p><img src="./images/branchements/rsp4_usb-c.png" alt="Branchement du Raspberry Pi 4 &#xE0; la batterie externe" title="Branchement du Raspberry Pi 4 &#xE0; la batterie externe"></p>
<h4 class="mume-header" id="lidar">Lidar</h4>

<p>Le lidar est branch&#xE9; &#xE0; l&apos;adaptateur qui permet de le brancher en USB au raspberry comme vu dans la section portant sur le <a href="###Radar-360-(RPLiDAR-A2M8)">Lidar</a>.</p>
<p>Pour l&apos;affichage graphique des donn&#xE9;es per&#xE7;ues par le Lidar, veuillez regarder la <a href="##Matplotlib">section parlant de Matplotlib</a> et pour ce qui est de l&apos;affichage des donn&#xE9;es en un quasi-temps r&#xE9;el, j&apos;utilise la m&#xEA;me m&#xE9;thode que pour la r&#xE9;cup&#xE9;ration du flux de la cam&#xE9;ra en temps r&#xE9;el.</p>
<h4 class="mume-header" id="fyling-fish">Fyling-Fish</h4>

<p>Les divers flying-fish sont branch&#xE9;s des c&#xE2;bles gris et violets &#xE0; l&apos;alimentation g&#xE9;n&#xE9;rale, mais les valeurs de sorties qu&apos;ils fournissent sont branch&#xE9;s avec des c&#xE2;bles bleus sur les <a href="#####Pi-4">GPIO</a> suivant du raspberry pi 4 :</p>
<p><img src="./images/branchements/flying_fish_gpio.png" alt="GPIO utilis&#xE9;s pour les flying-fish" title="GPIO utilis&#xE9;s pour les flying-fish"></p>
<h3 class="mume-header" id="raspberry-pi-0-wifi">Raspberry Pi 0 WiFi</h3>

<p>Le raspberry pi 0 WiFi est branch&#xE9; &#xE0; l&apos;alimentation g&#xE9;n&#xE9;rale et est aliment&#xE9; par les pins 4 et 6 du <a href="######Pi-4">GPIO</a>.</p>
<h4 class="mume-header" id="cam%C3%A9ra-1">Cam&#xE9;ra</h4>

<p>La cam&#xE9;ra est branch&#xE9; de la m&#xEA;me mani&#xE8;re que dans la <a href="####Cam%C3%A9ra">section explicant la module cam&#xE9;ra</a></p>
<h4 class="mume-header" id="bright-pi">Bright Pi</h4>

<p>Le bright Pi est branch&#xE9; sur l&apos;alimentation g&#xE9;n&#xE9;rale avec des c&#xE2;bles blancs et noirs. Les 2 autres c&#xE2;bles bleus et verts sont branch&#xE9;s sur des <a href="#####Pi-4">GPIO</a> I2C, donc les pins 2 et 9. Pour ce qui est du c&#xE2;blage pour les c&#xE2;bles bleus et verts, il est identique &#xE0; la <a href="###Phare-(Bright-Pi-v1.0)">section explicant ce qu&apos;est le bright pi</a>.</p>
<h2 class="mume-header" id="scripts">Scripts</h2>

<p>Dans cette section, nous allons parler des diff&#xE9;rents scripts utilis&#xE9;s ainsi que leurs comportement.</p>
<h3 class="mume-header" id="raspberry-pi-4-1">Raspberry Pi 4</h3>

<h4 class="mume-header" id="%C3%A0-quoi-sert-il">&#xC0; quoi sert-il ?</h4>

<p>Ce raspberry pi est le raspberry pi principale. C&apos;est-&#xE0;-dire que c&apos;est lui qui va &#xEA;tre le point d&apos;acc&#xE8;s par rapport aux autres rapsberry pi dont la voiture est &#xE9;quip&#xE9;e.</p>
<h4 class="mume-header" id="comment-on-lutilise">Comment on l&apos;utilise ?</h4>

<p>Pour ex&#xE9;cuter le script du serveur principal, il faut utiliser la commande <code>python3 server.py</code> depuis le r&#xE9;pertoire <code>/code/Flask/flask_server</code>. Ce script est un serveur Flask nous donnant acc&#xE8;s aux diff&#xE9;rentes fonctionnalit&#xE9;es de l&apos;application.</p>
<h4 class="mume-header" id="comment-fonctionne-t-il">Comment fonctionne-t-il ?</h4>

<p>Une fois le serveur lanc&#xE9;, et apr&#xE8;s nous &#xEA;tre rendu avec un navigateur web connect&#xE9; &#xE0; l&apos;adresse du raspberry pi et sur le port 5000 du r&#xE9;seau fournit par le raspberry pi 4. Exemple : <code>10.3.141.1:5000</code></p>
<h5 class="mume-header" id="barre-de-navigation-1">Barre de navigation</h5>

<p>La barre de navigation nous permet de changer de page. Cette derni&#xE8;re contient 5 &#xE9;l&#xE9;ments.</p>
<p><img src="./images/site_web/navbar.png" alt="Barre de navigation du site web" title="Barre de navigation du site web"></p>
<ul>
<li>A. Redirection sur la page d&apos;accueil</li>
<li>B. Redirection sur la page de t&#xE9;l&#xE9;commande</li>
<li>C. Redirection sur la page du tableau de bord</li>
<li>D. Cr&#xE9;ation d&apos;une connexion avec la voiture</li>
<li>E. D&#xE9;connexion avec la voiture</li>
</ul>
<h5 class="mume-header" id="page-daccueil">Page d&apos;accueil</h5>

<p>Ceci est la page sur laquelle on arrive lorsque l&apos;on tape l&apos;adresse IP du point d&apos;acc&#xE8;s avec le port 5000.</p>
<p><img src="./images/site_web/page_accueil.png" alt="Page d&apos;accueil du site web" title="Page d&apos;accueil du site web"></p>
<ul>
<li>A. Bouton cr&#xE9;ant une connexion avec la voiture</li>
</ul>
<h5 class="mume-header" id="page-de-t%C3%A9l%C3%A9commande">Page de t&#xE9;l&#xE9;commande</h5>

<p>Cette page permet, si une connexion avec la voiture est &#xE9;tablie, de contr&#xF4;ler la voiture.</p>
<p><img src="./images/site_web/page_telecommande.png" alt="Page de t&#xE9;l&#xE9;commande du site web" title="Page de t&#xE9;l&#xE9;commande du site web"></p>
<ul>
<li>A. Une barre coulissante allant de -100 &#xE0; 100 pour g&#xE9;rer la vitesse de la voiture</li>
<li>B. Une barre coulissante allant de -100 &#xE0; 100 pour g&#xE9;rer le guidon de la voiture</li>
<li>C. Bouton remettant le guidon &#xE0; sa position initiale</li>
<li>D. Bouton coupant les moteurs de la voiture</li>
<li>E. Bouton de d&#xE9;connexion &#xE0; la voiture</li>
</ul>
<p>Il est important de savoir que dans le code g&#xE9;rant les d&#xE9;placement de la voiture, j&apos;inverse les donn&#xE9;es et les divises par 100 car les valeurs sont comprisent entre -1 et 1. La raison pour laquelle j&apos;inverse par la suite les vitesses dans le code, c&apos;est parce que pour avancer avec la voiture, il faut lui donner une vitesse n&#xE9;gative, cependant je trouvais plus logique pour une interface utilisateur que pour avancer l&apos;on ajuste la barre coulissante &#xE0; droite.</p>
<h5 class="mume-header" id="page-du-tableau-de-bord">Page du tableau de bord</h5>

<p>Cette page permet &#xE0; l&apos;utilisateur de g&#xE9;rer les diff&#xE9;rents capteurs et de voir en temps r&#xE9;el les donn&#xE9;es re&#xE7;ues par les cam&#xE9;ras ainsi que par le Lidar.</p>
<p><img src="./images/site_web/page_dashboard.png" alt="Page de t&#xE9;l&#xE9;commande du site web" title="Page de t&#xE9;l&#xE9;commande du site web"></p>
<ul>
<li>A. Case &#xE0; cocher (d&#xE9;s)activant le mode automatique</li>
<li>B. Case &#xE0; cocher (d&#xE9;s)activant les leds &#xE0; la position indiqu&#xE9;e
<ul>
<li>Les cases de gauche allument les leds blanches, les cases de droites allument les leds infrarouges</li>
</ul>
</li>
<li>C. Case &#xE0; cocher (d&#xE9;s)activant la cam&#xE9;ra &#xE0; la position indiqu&#xE9;</li>
<li>D. Case &#xE0; cocher (d&#xE9;s)activant la r&#xE9;cuperation des donn&#xE9;es du Lidar</li>
</ul>
<p>De base, toutes les cam&#xE9;ras sont &#xE9;teintes ainsi que le radar :</p>
<p><img src="./images/site_web/page_dashboard_cam.png" alt="Cam&#xE9;ras &#xE9;teintes" title="Cam&#xE9;ras &#xE9;teintes"></p>
<p><img src="./images/site_web/page_dashboard_radar.png" alt="Radar &#xE9;teint" title="Radar &#xE9;teint"></p>
<p>Voici ce &#xE0; quoi &#xE7;a ressemble lorsque l&apos;on active une cam&#xE9;ra et le radar :</p>
<p><img src="./images/site_web/dashboard_graph_cam.gif" alt="Cam&#xE9;ra et radar activ&#xE9;" title="Cam&#xE9;ra et radar activ&#xE9;"></p>
<p>J&apos;ai choisis d&apos;afficher les &#xE9;l&#xE9;ments &#xE0; la suite, car l&apos;utilisateur va utiliser son t&#xE9;l&#xE9;phone pour se connecter &#xE0; l&apos;application. Il est donc plus pratique d&apos;avoir acc&#xE8;s aux &#xE9;l&#xE9;ments comme ceci &#xE9;tant sur un t&#xE9;l&#xE9;phone portable.</p>
<p>Pour comprendre comment le flux des cam&#xE9;ras sont r&#xE9;cup&#xE9;rer, veuillez regarder la <a href="#####R%C3%A9cup%C3%A9ration-du-flux-vid%C3%A9o">section parlant du r&#xE9;cup&#xE9;ration du flux vid&#xE9;o</a>.</p>
<h5 class="mume-header" id="page-cr%C3%A9ation-de-connexion">Page cr&#xE9;ation de connexion</h5>

<p>Lors de l&apos;appuie sur cet &#xE9;l&#xE9;ment, cela va lancer une connexion avec la voiture.</p>
<h5 class="mume-header" id="page-de-d%C3%A9connexion">Page de d&#xE9;connexion</h5>

<p>Lors de l&apos;appuie sur cet &#xE9;l&#xE9;ment, cela va lancer une d&#xE9;connexion avec la voiture.</p>
<h4 class="mume-header" id="comment-fonctionne-la-connexion-avec-la-voiture">Comment fonctionne la connexion avec la voiture ?</h4>

<p>La cr&#xE9;ation de la connexion avec la voiture s&apos;effectue dans la classe <code>car</code>. Cette classe lorsque l&apos;on cr&#xE9;e un nouvel objet, va demander une connexion Gatt au Technic Hub.</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">class</span> <span class="token class-name">CarController</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Class controlling the car&quot;&quot;&quot;</span>

    MY_MOVEHUB_ADD <span class="token operator">=</span> <span class="token string">&quot;90:84:2B:50:36:43&quot;</span>
    MY_BTCTRLR_HCI <span class="token operator">=</span> <span class="token string">&quot;hci0&quot;</span>
    MIN_ANGLE <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    MAX_ANGLE <span class="token operator">=</span> <span class="token number">1</span>
    DEFAULT_ANGLE <span class="token operator">=</span> <span class="token number">0</span>
    MAX_MOTOR_POWER <span class="token operator">=</span> <span class="token number">1</span>
    MOTOR_STOP_POWER <span class="token operator">=</span> <span class="token number">0</span>
    MAXIMUM_SPEED_WHEN_GROUND_ISNT_DETECTED <span class="token operator">=</span> <span class="token number">0.2</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cls<span class="token punctuation">.</span>connection <span class="token operator">=</span> get_connection_gatt<span class="token punctuation">(</span>hub_mac<span class="token operator">=</span>cls<span class="token punctuation">.</span>MY_MOVEHUB_ADD<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            cls<span class="token punctuation">.</span>movehub <span class="token operator">=</span> MoveHub<span class="token punctuation">(</span>cls<span class="token punctuation">.</span>connection<span class="token punctuation">)</span>
            <span class="token comment"># The motors</span>
            cls<span class="token punctuation">.</span>front_motor <span class="token operator">=</span> Motor<span class="token punctuation">(</span>cls<span class="token punctuation">.</span>movehub<span class="token punctuation">,</span> cls<span class="token punctuation">.</span>movehub<span class="token punctuation">.</span>PORT_A<span class="token punctuation">)</span>
            cls<span class="token punctuation">.</span>back_motor <span class="token operator">=</span> Motor<span class="token punctuation">(</span>cls<span class="token punctuation">.</span>movehub<span class="token punctuation">,</span> cls<span class="token punctuation">.</span>movehub<span class="token punctuation">.</span>PORT_B<span class="token punctuation">)</span>
            cls<span class="token punctuation">.</span>directionnal_motor <span class="token operator">=</span> EncodedMotor<span class="token punctuation">(</span>cls<span class="token punctuation">.</span>movehub<span class="token punctuation">,</span> cls<span class="token punctuation">.</span>movehub<span class="token punctuation">.</span>PORT_C<span class="token punctuation">)</span>
            cls<span class="token punctuation">.</span>old_angle <span class="token operator">=</span> cls<span class="token punctuation">.</span>DEFAULT_ANGLE
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            cls<span class="token punctuation">.</span>movehub <span class="token operator">=</span> <span class="token boolean">None</span>
            cls<span class="token punctuation">.</span>front_motor <span class="token operator">=</span> <span class="token boolean">None</span>
            cls<span class="token punctuation">.</span>back_motor <span class="token operator">=</span> <span class="token boolean">None</span>
            cls<span class="token punctuation">.</span>directionnal_motor <span class="token operator">=</span> <span class="token boolean">None</span>
            cls<span class="token punctuation">.</span>instance <span class="token operator">=</span> <span class="token boolean">None</span>
            cls<span class="token punctuation">.</span>connection <span class="token operator">=</span> <span class="token boolean">None</span>
            cls<span class="token punctuation">.</span>old_angle <span class="token operator">=</span> <span class="token boolean">None</span>

</pre><p>On fait un try/except car si la demande n&apos;est pas aboutie, il faut que l&apos;on puisse tout de m&#xEA;me remplir les champs de la classe.</p>
<p>Voici la route qui permet de cr&#xE9;er la connexion :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/create_car/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Used to the creation of the car&quot;&quot;&quot;</span>
    <span class="token keyword">global</span> car
    car <span class="token operator">=</span> CarController<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>car<span class="token punctuation">,</span> <span class="token string">&quot;connection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">&quot;form_remote_car.html&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        car <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span>
            <span class="token string">&quot;error.html&quot;</span><span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token string">&quot;Une connexion est n&#xE9;cessaire pour pouvoir int&#xE9;ragir avec&quot;</span>
        <span class="token punctuation">)</span>
</pre><p>Lors de l&apos;appel &#xE0; la route ci-dessus, il ne faut pas oublier de cliquer sur le bouton vert du <code>Technic Hub</code>.</p>
<p><img src="./images/technic_hub/connexion_technichub.png" alt="Pr&#xE9;paration du Technic Hub &#xE0; l&apos;appareillage" title="Pr&#xE9;paration du Technic Hub &#xE0; l&apos;appareillage"></p>
<p>Il est important de noter que la voiture est stock&#xE9;e dans une variable globale car ceci nous permet de alors d&apos;avoir acc&#xE8;s &#xE0; la voiture depuis divers m&#xE9;thodes. &#xC0; la base, cette connexion avec la voiture &#xE9;tait faite &#xE0; travers le design pattern du Singelton :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span>instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        cls<span class="token punctuation">.</span>instance <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>CarController<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>
        cls<span class="token punctuation">.</span>connection <span class="token operator">=</span> get_connection_gatt<span class="token punctuation">(</span>hub_mac<span class="token operator">=</span>cls<span class="token punctuation">.</span>MY_MOVEHUB_ADD<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            cls<span class="token punctuation">.</span>movehub <span class="token operator">=</span> MoveHub<span class="token punctuation">(</span>cls<span class="token punctuation">.</span>connection<span class="token punctuation">)</span>
            <span class="token comment"># The motors</span>
            cls<span class="token punctuation">.</span>front_motor <span class="token operator">=</span> Motor<span class="token punctuation">(</span>cls<span class="token punctuation">.</span>movehub<span class="token punctuation">,</span> cls<span class="token punctuation">.</span>movehub<span class="token punctuation">.</span>PORT_A<span class="token punctuation">)</span>
            cls<span class="token punctuation">.</span>back_motor <span class="token operator">=</span> Motor<span class="token punctuation">(</span>cls<span class="token punctuation">.</span>movehub<span class="token punctuation">,</span> cls<span class="token punctuation">.</span>movehub<span class="token punctuation">.</span>PORT_B<span class="token punctuation">)</span>
            cls<span class="token punctuation">.</span>directionnal_motor <span class="token operator">=</span> EncodedMotor<span class="token punctuation">(</span>cls<span class="token punctuation">.</span>movehub<span class="token punctuation">,</span> cls<span class="token punctuation">.</span>movehub<span class="token punctuation">.</span>PORT_C<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            cls<span class="token punctuation">.</span>movehub <span class="token operator">=</span> <span class="token boolean">None</span>
            cls<span class="token punctuation">.</span>front_motor <span class="token operator">=</span> <span class="token boolean">None</span>
            cls<span class="token punctuation">.</span>back_motor <span class="token operator">=</span> <span class="token boolean">None</span>
            cls<span class="token punctuation">.</span>directionnal_motor <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">return</span> cls<span class="token punctuation">.</span>instance
</pre><p>Le probl&#xE8;me que le Singleton avait &#xE9;tait que des fois, il perdait la connexion &#xE0; la voiture alors que l&apos;instance de l&apos;objet &#xE9;tait toujours pr&#xE9;sente. C&apos;est-&#xE0;-dire, que lorsque l&apos;on se d&#xE9;connectait de la voiture &#xE0; l&apos;aide de la m&#xE9;thode de d&#xE9;connexion appel&#xE9;e par la route :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token comment"># Code pr&#xE9;sent dans la classe CarController</span>
<span class="token keyword">def</span> <span class="token function">disconnect</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Code pr&#xE9;sent dans le fichier server.py dans le r&#xE9;pertoire /code/Flask/flask_server/</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/close_connection/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">close_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Close the connection between the Raspberry Pi and the Technic Hub&quot;&quot;&quot;</span>
    <span class="token keyword">global</span> car
    output <span class="token operator">=</span> <span class="token string">&quot;Connexion toujours en cours&quot;</span>
    <span class="token keyword">if</span> car <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        car<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span><span class="token punctuation">)</span>
        output <span class="token operator">=</span> <span class="token string">&quot;Connexion ferm&#xE9;e avec l&apos;appareil {0}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>car<span class="token punctuation">.</span>MY_MOVEHUB_ADD<span class="token punctuation">)</span>
        car <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">&quot;connection.html&quot;</span><span class="token punctuation">,</span> msg<span class="token operator">=</span>output<span class="token punctuation">)</span>

</pre><h4 class="mume-header" id="comment-fonctionne-la-r%C3%A9cup%C3%A9ration-des-donn%C3%A9es-du-lidar">Comment fonctionne la r&#xE9;cup&#xE9;ration des donn&#xE9;es du Lidar ?</h4>

<p>Pour activer l&apos;API C++ pour y r&#xE9;cup&#xE9;rer les distances &#xE0; chaque angles qui sont &#xE9;crits dans la console et afin d&apos;&#xE9;viter de rendre le code bloquant, j&apos;ai utilis&#xE9; <code>Asyncio</code>.</p>
<p>Voici le code permettant l&apos;appel et le traitement asynchrone des donn&#xE9;es :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/bg_processing_lidar/&lt;string:state&gt;&quot;</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">bg_process_lidar</span><span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Process the values passed by Javascript&quot;&quot;&quot;</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> RuntimeError<span class="token punctuation">:</span>  <span class="token comment"># no event loop running:</span>
        loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>new_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>should_scan<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    The main function which calls the run loop async

    should_scan : The code to know if the program should scan or not
    &quot;&quot;&quot;</span>
    <span class="token keyword">await</span> run<span class="token punctuation">(</span>should_scan<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>should_scan<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Will run the subprocess and bind the async method

    should_scan : The code to know if the program should scan or not
    &quot;&quot;&quot;</span>
    command <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;./scanner/simple_grabber /dev/ttyUSB0 &quot;</span> <span class="token operator">+</span> should_scan<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
    process <span class="token operator">=</span> <span class="token keyword">await</span> create_subprocess_exec<span class="token punctuation">(</span><span class="token operator">*</span>command<span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">[</span>_read_stream<span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">{</span>get_radar_data<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> process<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_read_stream</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Will read the text in the console from the process simple_grabber

    stream : The streaming of the data in the console
    callback : The method to call when data has been received

    &quot;&quot;&quot;</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        line <span class="token operator">=</span> <span class="token keyword">await</span> stream<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> line<span class="token punctuation">:</span>
            callback<span class="token punctuation">(</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

<span class="token keyword">def</span> <span class="token function">get_radar_data</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Will parse the data received in text by the Lidar

    row : Row to read and to add or modify in the array of angles
    &quot;&quot;&quot;</span>
    <span class="token keyword">global</span> rows
    <span class="token comment"># row normaly is like [angle, distance]</span>
    tmp <span class="token operator">=</span> row
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        angle <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># remove the line return</span>
        dist <span class="token operator">=</span> tmp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b&quot;\n&quot;</span><span class="token punctuation">,</span> <span class="token string">b&quot;&quot;</span><span class="token punctuation">)</span>
        rows<span class="token punctuation">[</span>angle<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>dist<span class="token punctuation">)</span>

</pre><p>Comme l&apos;on peut le voir, lors de l&apos;activation ainsi que de la d&#xE9;sactivation du Lidar. On effectue un processus car &#xE9;tant donn&#xE9; que dans le code de l&apos;API, il s&apos;agit d&apos;une boucle infinie r&#xE9;cup&#xE9;rant et lissant les donn&#xE9;es qui sont affich&#xE9;es dans la console, on a besoin de mani&#xE8;re asynchrone &#xE0; traiter ses donn&#xE9;es et &#xE0; les mettre dans le tableau.</p>
<p>C&apos;est ce &#xE0; quoi sert la m&#xE9;thode <code>_read_stream</code>. Cette m&#xE9;thode nous permet de lire ligne par ligne le contenu de sortie de la console (<code>process.stdout</code>) et en l&apos;ajoutant dans le tableau avec la m&#xE9;thode <code>get_radar_data(row)</code>.</p>
<p><img src="./images/lidar/flowchart_lidar_api.png" alt="M&#xE9;thode utilis&#xE9;e pour r&#xE9;cup&#xE9;rer en temps r&#xE9;el les donn&#xE9;es du Lidar" title="M&#xE9;thode utilis&#xE9;e pour r&#xE9;cup&#xE9;rer en temps r&#xE9;el les donn&#xE9;es du Lidar"></p>
<h5 class="mume-header" id="code-de-lapi-c-modifi%C3%A9">Code de l&apos;API C++ modifi&#xE9;</h5>

<pre data-role="codeBlock" data-info="cpp" class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>opt_com_path <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    _u32 opt_com_baudrate <span class="token operator">=</span> <span class="token number">115200</span><span class="token punctuation">;</span>
    u_result op_result<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> run_scan <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// check if the the program should run scans</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> arg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>arg <span class="token operator">==</span> <span class="token string">&apos;1&apos;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            run_scan <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>arg <span class="token operator">==</span> <span class="token string">&apos;0&apos;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            run_scan <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">print_usage</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    opt_com_path <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// create the driver instance</span>
    RPlidarDriver <span class="token operator">*</span>drv <span class="token operator">=</span> <span class="token class-name">RPlidarDriver</span><span class="token operator">::</span><span class="token function">CreateDriver</span><span class="token punctuation">(</span>DRIVER_TYPE_SERIALPORT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>drv<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;insufficent memory, exit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    rplidar_response_device_health_t healthinfo<span class="token punctuation">;</span>
    rplidar_response_device_info_t devinfo<span class="token punctuation">;</span>
    <span class="token keyword">do</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// try to connect</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_FAIL</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span>opt_com_path<span class="token punctuation">,</span> opt_com_baudrate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Error, cannot bind to the specified serial port %s.\n&quot;</span><span class="token punctuation">,</span> opt_com_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        op_result <span class="token operator">=</span> drv<span class="token operator">-&gt;</span><span class="token function">getDeviceInfo</span><span class="token punctuation">(</span>devinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_FAIL</span><span class="token punctuation">(</span>op_result<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>op_result <span class="token operator">==</span> RESULT_OPERATION_TIMEOUT<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// you can check the detailed failure reason</span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Error, operation time out.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Error, unexpected error, code: %x\n&quot;</span><span class="token punctuation">,</span> op_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// other unexpected result</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        op_result <span class="token operator">=</span> drv<span class="token operator">-&gt;</span><span class="token function">getHealth</span><span class="token punctuation">(</span>healthinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_OK</span><span class="token punctuation">(</span>op_result<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span> <span class="token comment">// the macro IS_OK is the preperred way to judge whether the operation is succeed.</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>healthinfo<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
            <span class="token keyword">case</span> RPLIDAR_STATUS_WARNING<span class="token operator">:</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Warning.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RPLIDAR_STATUS_ERROR<span class="token operator">:</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Error.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot; (errorcode: %d)\n&quot;</span><span class="token punctuation">,</span> healthinfo<span class="token punctuation">.</span>error_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Error, cannot retrieve the lidar health code: %x\n&quot;</span><span class="token punctuation">,</span> op_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>healthinfo<span class="token punctuation">.</span>status <span class="token operator">==</span> RPLIDAR_STATUS_ERROR<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Error, rplidar internal error detected. Please reboot the device to retry.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        drv<span class="token operator">-&gt;</span><span class="token function">startMotor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_FAIL</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span><span class="token function">startScan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// you can force rplidar to perform scan operation regardless whether the motor is rotating</span>
        <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Error, cannot start the scan operation.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> max_size_arr_angle_dist <span class="token operator">=</span> <span class="token number">360</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> angle_dist_tmp<span class="token punctuation">[</span>max_size_arr_angle_dist<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> angle_dist<span class="token punctuation">[</span>max_size_arr_angle_dist<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> size_arr_angle_dist <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>angle_dist<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>angle_dist<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token keyword">int</span> MAX_RANGE_LIDAR <span class="token operator">=</span> <span class="token number">16000.0f</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> MIN_RANGE_LIDAR <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
        <span class="token comment">// used as a code in order to treat the data below in another process</span>
        <span class="token comment">//printf(&quot;&lt;&lt;&lt;\n&quot;);</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>run_scan<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//reset the array to empty (empty represented by the 0)</span>
            std<span class="token operator">::</span><span class="token function">fill_n</span><span class="token punctuation">(</span>angle_dist<span class="token punctuation">,</span> max_size_arr_angle_dist<span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">capture_and_display</span><span class="token punctuation">(</span>angle_dist<span class="token punctuation">,</span> drv<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>size_arr_angle_dist <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Error, cannot grab scan data.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">/* Correct the errors */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> max_size_arr_angle_dist<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>angle_dist<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> MIN_RANGE_LIDAR <span class="token operator">&amp;&amp;</span> angle_dist<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> MAX_RANGE_LIDAR<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    angle_dist<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> MIN_RANGE_LIDAR<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* make the average of distance */</span>
            <span class="token function">capture_and_display</span><span class="token punctuation">(</span>angle_dist_tmp<span class="token punctuation">,</span> drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> max_size_arr_angle_dist<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>angle_dist_tmp<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&gt;</span> MIN_RANGE_LIDAR <span class="token operator">&amp;&amp;</span> angle_dist_tmp<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> MAX_RANGE_LIDAR<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    angle_dist<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>angle_dist<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> angle_dist_tmp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> max_size_arr_angle_dist<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d,%f\n&quot;</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> angle_dist<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    drv<span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    drv<span class="token operator">-&gt;</span><span class="token function">stopMotor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">RPlidarDriver</span><span class="token operator">::</span><span class="token function">DisposeDriver</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</pre><h5 class="mume-header" id="quest-ce-quasyncio">Qu&apos;est-ce qu&apos;Asyncio ?</h5>

<p><a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.AbstractEventLoop.run_forever">Asyncio</a> est une librairie python nous permettant d&apos;&#xE9;crire du code <code>concurrent</code> c&apos;est &#xE0; dire sur diff&#xE9;rents thread &#xE0; l&apos;aide de la syntaxe async / await.</p>
<p>Pour installer asyncio il faut ex&#xE9;cuter la commande <code>sudo pip3 install asyncio</code>.</p>
<h6 class="mume-header" id="comment-est-ce-quil-sutilise">Comment est-ce qu&apos;il s&apos;utilise ?</h6>

<p>Voici un code d&apos;exemple pour montrer la m&#xE9;canique :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">import</span> asyncio

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment"># Tente de r&#xE9;cup&#xE9;rer la r&#xE9;f&#xE9;rence d&apos;une boucle</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> RuntimeError<span class="token punctuation">:</span>  
    <span class="token comment"># Si aucune r&#xE9;f&#xE9;rence n&apos;a &#xE9;t&#xE9; trouv&#xE9;e, on cr&#xE9;e une nouvelle boucle</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>new_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token comment"># Ex&#xE9;cution de la m&#xE9;thode jusqu&apos;&#xE0; ce qu&apos;elle soit finie</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token string">&quot;Ceci est un message asynchrone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
</pre><p>Il est important de savoir qu&apos;il existe 2 diff&#xE9;rentes mani&#xE8;re d&apos;ex&#xE9;cuter le code.</p>
<ol>
<li><code>run_until_complete</code>, va ex&#xE9;cuter le code jusqu&apos;&#xE0; &#xEA;tre arriv&#xE9; &#xE0; la fin de la m&#xE9;thode.</li>
<li><code>run_forever</code>, va ex&#xE9;cuter le code en boucle jusqu&apos;&#xE0; ce que l&apos;on stop la boucle avec <code>loop.stop()</code>.</li>
</ol>
<h4 class="mume-header" id="comment-fonctionne-la-gestion-du-d%C3%A9placement-de-la-voiture">Comment fonctionne la gestion du d&#xE9;placement de la voiture ?</h4>

<h5 class="mume-header" id="t%C3%A9l%C3%A9commande">T&#xE9;l&#xE9;commande</h5>

<p>La t&#xE9;l&#xE9;commande effectue des appels AJAX avec les valeurs des barres coulissantes comme ceci :</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span><span class="token operator">&gt;</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&apos;input&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;#rngMove&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&apos;input&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;#rngRotationAngle&apos;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token method function property-access">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token operator">:</span> <span class="token string">&apos;/bg_processing_car/&apos;</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&apos;form&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">&apos;POST&apos;</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;action performed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</pre><p>Les ID <code>rngMove</code> et <code>rngRotationAngle</code> sont ceux attach&#xE9;s aux barres coulissantes. &#xC0; chaque changement de valeurs, qu&apos;il s&apos;agisse du guidon ou de la vitesse des moteurs, la route appel&#xE9;e &#xE0; l&apos;aide d&apos;AJAX <code>/bg_processing_car/</code> se charge de faire le traitement :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/bg_processing_car/&quot;</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">bg_process_car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Process the values passed by Javascript&quot;&quot;&quot;</span>

    <span class="token keyword">global</span> car

    move_speed <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">&quot;rngMove&quot;</span><span class="token punctuation">]</span>
    angle_rotation <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">&quot;rngRotationAngle&quot;</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> car <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># Convert the values</span>
        move_speed <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>move_speed<span class="token punctuation">)</span>
        angle_rotation <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>angle_rotation<span class="token punctuation">)</span>
        <span class="token comment"># Get the allowed actions of the car</span>
        actions <span class="token operator">=</span> get_actions_for_car<span class="token punctuation">(</span>move_speed<span class="token punctuation">)</span>
        car<span class="token punctuation">.</span>move<span class="token punctuation">(</span>move_speed<span class="token punctuation">,</span> angle_rotation<span class="token punctuation">,</span> actions<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span>
        <span class="token string">&quot;form_remote_car.html&quot;</span><span class="token punctuation">,</span>
        speed<span class="token operator">=</span>move_speed<span class="token punctuation">,</span>
        angle<span class="token operator">=</span>angle_rotation<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_actions_for_car</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Process the actions that the car is allowed to do according to the flying-fish&quot;&quot;&quot;</span>
    actions <span class="token operator">=</span> <span class="token punctuation">(</span>constants<span class="token punctuation">.</span>CODE_TURN_NOTHING<span class="token punctuation">,</span> constants<span class="token punctuation">.</span>CODE_MOVE_NOTHING<span class="token punctuation">)</span>
    <span class="token comment"># INDEX 0 represent the turn code</span>
    <span class="token comment"># INDEX 1 represent the move code</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_FRONT_LEFT<span class="token punctuation">)</span>
        <span class="token keyword">and</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_FRONT_RIGHT<span class="token punctuation">)</span>
        <span class="token keyword">and</span> <span class="token keyword">not</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_BACK_LEFT<span class="token punctuation">)</span>
        <span class="token keyword">and</span> <span class="token keyword">not</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_BACK_RIGHT<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;les deux avant&quot;</span><span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token punctuation">(</span>constants<span class="token punctuation">.</span>CODE_TURN_NOTHING<span class="token punctuation">,</span> constants<span class="token punctuation">.</span>CODE_MOVE_BACKWARD<span class="token punctuation">)</span>

    <span class="token keyword">elif</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_FRONT_LEFT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;gauche avant&quot;</span><span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token punctuation">(</span>constants<span class="token punctuation">.</span>CODE_TURN_RIGHT<span class="token punctuation">,</span> constants<span class="token punctuation">.</span>CODE_MOVE_NOTHING<span class="token punctuation">)</span>

    <span class="token keyword">elif</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_FRONT_RIGHT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;droite avant&quot;</span><span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token punctuation">(</span>constants<span class="token punctuation">.</span>CODE_TURN_LEFT<span class="token punctuation">,</span> constants<span class="token punctuation">.</span>CODE_MOVE_NOTHING<span class="token punctuation">)</span>

    <span class="token keyword">elif</span> <span class="token punctuation">(</span>
        <span class="token keyword">not</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_FRONT_LEFT<span class="token punctuation">)</span>
        <span class="token keyword">and</span> <span class="token keyword">not</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_FRONT_RIGHT<span class="token punctuation">)</span>
        <span class="token keyword">and</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_BACK_LEFT<span class="token punctuation">)</span>
        <span class="token keyword">and</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_BACK_RIGHT<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;les deux arri&#xE8;re&quot;</span><span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token punctuation">(</span>constants<span class="token punctuation">.</span>CODE_TURN_NOTHING<span class="token punctuation">,</span> constants<span class="token punctuation">.</span>CODE_MOVE_FORWARD<span class="token punctuation">)</span>

    <span class="token keyword">elif</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_BACK_LEFT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;gauche arri&#xE8;re&quot;</span><span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token punctuation">(</span>constants<span class="token punctuation">.</span>CODE_TURN_RIGHT<span class="token punctuation">,</span> constants<span class="token punctuation">.</span>CODE_MOVE_FORWARD<span class="token punctuation">)</span>

    <span class="token keyword">elif</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_BACK_RIGHT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;droite arri&#xE8;re&quot;</span><span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token punctuation">(</span>constants<span class="token punctuation">.</span>CODE_TURN_LEFT<span class="token punctuation">,</span> constants<span class="token punctuation">.</span>CODE_MOVE_FORWARD<span class="token punctuation">)</span>

    <span class="token keyword">return</span> actions
</pre><p>Voici le code de d&#xE9;placement pour la voiture dans la classe <code>CarController</code> :</p>
<pre data-role="codeBlock" data-info="python" class="language-python">    <span class="token keyword">def</span> <span class="token function">move</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> motor_speed<span class="token punctuation">,</span> angle_rotation<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Moves the car with a specific speed and rotation

        motor_speed : The motor&apos;s speed
                      NOTE : to move forward, the value must be reversed because it is basically negative
        angle_rotation : The rotation of the directionnal motor
        actions : The list of the possible actions
        &quot;&quot;&quot;</span>
        <span class="token comment"># Invert the power direction</span>
        <span class="token keyword">if</span> motor_speed <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            motor_speed <span class="token operator">*=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token comment"># Max value of motor is -1 and +1 but in the HTML form, the range input can be set between -100 to +100</span>
        motor_speed <span class="token operator">/=</span> <span class="token number">100</span>
        angle_rotation <span class="token operator">/=</span> <span class="token number">100</span>

        <span class="token comment"># INDEX 0 represent the turn code</span>
        <span class="token comment"># INDEX 1 represent the move code</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> actions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> constants<span class="token punctuation">.</span>CODE_TURN_LEFT <span class="token keyword">and</span> angle_rotation <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>turn<span class="token punctuation">(</span>angle_rotation<span class="token punctuation">)</span>

            <span class="token keyword">elif</span> actions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> constants<span class="token punctuation">.</span>CODE_TURN_RIGHT <span class="token keyword">and</span> angle_rotation <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>turn<span class="token punctuation">(</span>angle_rotation<span class="token punctuation">)</span>

            <span class="token keyword">elif</span> actions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> constants<span class="token punctuation">.</span>CODE_TURN_NOTHING<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>turn<span class="token punctuation">(</span>angle_rotation<span class="token punctuation">)</span>

            <span class="token keyword">if</span> actions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> constants<span class="token punctuation">.</span>CODE_MOVE_FORWARD <span class="token keyword">and</span> motor_speed <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> motor_speed <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>MAXIMUM_SPEED_WHEN_GROUND_ISNT_DETECTED<span class="token punctuation">:</span>
                    motor_speed <span class="token operator">=</span> self<span class="token punctuation">.</span>MAXIMUM_SPEED_WHEN_GROUND_ISNT_DETECTED
                self<span class="token punctuation">.</span>front_motor<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span>motor_speed<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>back_motor<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span>motor_speed<span class="token punctuation">)</span>

            <span class="token keyword">elif</span> actions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> constants<span class="token punctuation">.</span>CODE_MOVE_BACKWARD <span class="token keyword">and</span> motor_speed <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> motor_speed <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>MAXIMUM_SPEED_WHEN_GROUND_ISNT_DETECTED<span class="token punctuation">:</span>
                    motor_speed <span class="token operator">=</span> self<span class="token punctuation">.</span>MAXIMUM_SPEED_WHEN_GROUND_ISNT_DETECTED
                self<span class="token punctuation">.</span>front_motor<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span>motor_speed<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>back_motor<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span>motor_speed<span class="token punctuation">)</span>

            <span class="token keyword">elif</span> actions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> constants<span class="token punctuation">.</span>CODE_MOVE_NOTHING<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>front_motor<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span>motor_speed<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>back_motor<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span>motor_speed<span class="token punctuation">)</span>
        <span class="token keyword">except</span> AssertionError<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">turn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Turn the directionnal motor from the input value

        angle : The angle we wants the directionnal motor goes to
        &quot;&quot;&quot;</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>directionnal_motor<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span>angle<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>old_angle <span class="token operator">=</span> angle
        <span class="token keyword">except</span> AssertionError<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">reset_handlebar</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Reset the angle</span>
        angle <span class="token operator">=</span> self<span class="token punctuation">.</span>old_angle <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">1</span>
        angle <span class="token operator">/=</span> <span class="token number">2</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>directionnal_motor<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span>angle<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>old_angle <span class="token operator">=</span> angle
        <span class="token keyword">except</span> AssertionError<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">stop_moving</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Stop the motors&quot;&quot;&quot;</span>
        <span class="token comment"># Reset the angle</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>reset_handlebar<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>front_motor<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span>self<span class="token punctuation">.</span>MOTOR_STOP_POWER<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>back_motor<span class="token punctuation">.</span>start_power<span class="token punctuation">(</span>self<span class="token punctuation">.</span>MOTOR_STOP_POWER<span class="token punctuation">)</span>
        <span class="token keyword">except</span> AssertionError<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
</pre><p>On peut remarquer que dans les diff&#xE9;rentes m&#xE9;thodes j&apos;utilise des <code>try</code> / <code>except</code>. Je suis oblig&#xE9; de les utiliser, car lors de l&apos;envoie d&apos;une commande au <code>Technic Hub</code>, il doit retourner une r&#xE9;ponse, cependant des fois il se peut que pendant qu&apos;il traite une commande, avant qu&apos;il aie pu r&#xE9;pondre une autre commande lui soit envoy&#xE9;e. Ce qui cause un probl&#xE8;me de confirmation, et qui par cons&#xE9;quent faisait crash le programme.</p>
<h5 class="mume-header" id="boutons">Boutons</h5>

<p>Pour comprendre plus en d&#xE9;tail le r&#xF4;le des boutons, veuillez vous r&#xE9;f&#xE9;rer &#xE0; la <a href="#####Page-de-t%C3%A9l%C3%A9commande">section d&#xE9;crivant l&apos;interface pour la t&#xE9;l&#xE9;commande</a>.</p>
<p>Voici comment les actions qu&apos;ils produisent sont g&#xE9;r&#xE9;es :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/form_remote_response/&quot;</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">form_remote_response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;The form&apos;s answer of the remote&quot;&quot;&quot;</span>
    <span class="token keyword">global</span> car
    <span class="token comment"># Init</span>
    move_speed <span class="token operator">=</span> constants<span class="token punctuation">.</span>DEFAULT_SPEED
    angle_rotation <span class="token operator">=</span> constants<span class="token punctuation">.</span>DEFAULT_ANGLE

    returned_value <span class="token operator">=</span> render_template<span class="token punctuation">(</span>
        <span class="token string">&quot;form_remote_car.html&quot;</span><span class="token punctuation">,</span>
        speed<span class="token operator">=</span>move_speed<span class="token punctuation">,</span>
        angle<span class="token operator">=</span>angle_rotation<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    error <span class="token operator">=</span> render_template<span class="token punctuation">(</span>
        <span class="token string">&quot;error.html&quot;</span><span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token string">&quot;Une connexion est n&#xE9;cessaire pour pouvoir int&#xE9;ragir avec&quot;</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">&quot;send_request&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> constants<span class="token punctuation">.</span>BTN_REQUEST_RESET_ANGLE<span class="token punctuation">:</span>
            <span class="token keyword">if</span> car <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                car<span class="token punctuation">.</span>reset_handlebar<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                returned_value <span class="token operator">=</span> error
        <span class="token keyword">elif</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">&quot;send_request&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> constants<span class="token punctuation">.</span>BTN_REQUEST_STOP<span class="token punctuation">:</span>
            <span class="token keyword">if</span> car <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                car<span class="token punctuation">.</span>stop_moving<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                returned_value <span class="token operator">=</span> error
        <span class="token keyword">elif</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">&quot;send_request&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> constants<span class="token punctuation">.</span>BTN_REQUEST_DISCONNECT<span class="token punctuation">:</span>
            returned_value <span class="token operator">=</span> redirect<span class="token punctuation">(</span><span class="token string">&quot;/close_connection/&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> returned_value
</pre><h5 class="mume-header" id="comment-fonctionne-le-syst%C3%A8me-darr%C3%AAt-durgence-de-la-voiture">Comment fonctionne le syst&#xE8;me d&apos;arr&#xEA;t d&apos;urgence de la voiture ?</h5>

<p>Le syst&#xE8;me d&apos;argent d&apos;urgence est bas&#xE9; sur ce que les <a href="###D%C3%A9tecteur-infrarouge-(Flying-Fish)">Flying-Fish</a> d&#xE9;tectent.</p>
<p>Au lancement de l&apos;application, la m&#xE9;thode <code>initFlyingFish()</code> est ex&#xE9;cut&#xE9;e, ils ont tous &#xE9;t&#xE9; attach&#xE9;s &#xE0; une m&#xE9;thode qui se d&#xE9;clenchera &#xE0; chaque changement d&apos;&#xE9;tat :</p>
<pre data-role="codeBlock" data-info="python" class="language-python">flying_fish_state <span class="token operator">=</span> <span class="token punctuation">[</span>
    constants<span class="token punctuation">.</span>FLYING_FISH_STATE_GROUNDED<span class="token punctuation">,</span>
    constants<span class="token punctuation">.</span>FLYING_FISH_STATE_GROUNDED<span class="token punctuation">,</span>
    constants<span class="token punctuation">.</span>FLYING_FISH_STATE_GROUNDED<span class="token punctuation">,</span>
    constants<span class="token punctuation">.</span>FLYING_FISH_STATE_GROUNDED<span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">initFlyingfish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Set the mode into Broadcom SOC channel</span>
    <span class="token comment"># It allows to use GPIO number instead of pin number</span>
    GPIO<span class="token punctuation">.</span>setmode<span class="token punctuation">(</span>GPIO<span class="token punctuation">.</span>BCM<span class="token punctuation">)</span>
    <span class="token comment"># Set the GPIO into input mode</span>
    GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_FRONT_RIGHT<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>IN<span class="token punctuation">)</span>
    GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_FRONT_LEFT<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>IN<span class="token punctuation">)</span>
    GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_BACK_RIGHT<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>IN<span class="token punctuation">)</span>
    GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_BACK_LEFT<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>IN<span class="token punctuation">)</span>

    <span class="token comment"># Add the events</span>
    GPIO<span class="token punctuation">.</span>add_event_detect<span class="token punctuation">(</span>
        constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_FRONT_RIGHT<span class="token punctuation">,</span> <span class="token comment"># GPIO 17</span>
        GPIO<span class="token punctuation">.</span>FALLING<span class="token punctuation">,</span>
        callback<span class="token operator">=</span>get_grounded_state<span class="token punctuation">,</span>
        bouncetime<span class="token operator">=</span>constants<span class="token punctuation">.</span>GPIO_BOUNCEBACK<span class="token punctuation">,</span> 
    <span class="token punctuation">)</span>
    GPIO<span class="token punctuation">.</span>add_event_detect<span class="token punctuation">(</span>
        constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_FRONT_LEFT<span class="token punctuation">,</span>  <span class="token comment"># GPIO 27</span>
        GPIO<span class="token punctuation">.</span>FALLING<span class="token punctuation">,</span>
        callback<span class="token operator">=</span>get_grounded_state<span class="token punctuation">,</span>
        bouncetime<span class="token operator">=</span>constants<span class="token punctuation">.</span>GPIO_BOUNCEBACK<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    GPIO<span class="token punctuation">.</span>add_event_detect<span class="token punctuation">(</span>
        constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_BACK_RIGHT<span class="token punctuation">,</span>  <span class="token comment"># GPIO 23</span>
        GPIO<span class="token punctuation">.</span>FALLING<span class="token punctuation">,</span>
        callback<span class="token operator">=</span>get_grounded_state<span class="token punctuation">,</span>
        bouncetime<span class="token operator">=</span>constants<span class="token punctuation">.</span>GPIO_BOUNCEBACK<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    GPIO<span class="token punctuation">.</span>add_event_detect<span class="token punctuation">(</span>
        constants<span class="token punctuation">.</span>GPIO_FLYING_FISH_BACK_LEFT<span class="token punctuation">,</span>  <span class="token comment"># GPIO 24</span>
        GPIO<span class="token punctuation">.</span>FALLING<span class="token punctuation">,</span>
        callback<span class="token operator">=</span>get_grounded_state<span class="token punctuation">,</span>
        bouncetime<span class="token operator">=</span>constants<span class="token punctuation">.</span>GPIO_BOUNCEBACK<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_grounded_state</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Will stop the motors if the ground isn&apos;t detected anymore&quot;&quot;&quot;</span>
    <span class="token keyword">global</span> car
    <span class="token keyword">global</span> flying_fish_state

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> sensor_state <span class="token keyword">in</span> flying_fish_state<span class="token punctuation">:</span>
            input_values <span class="token operator">=</span> <span class="token keyword">not</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>GPIO_FLYING_FISH<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> sensor_state <span class="token operator">!=</span> input_values<span class="token punctuation">:</span>
                <span class="token keyword">if</span> car <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>input_values<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                    car<span class="token punctuation">.</span>stop_moving<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># Invert his state</span>
                sensor_state <span class="token operator">=</span> input_values
        flying_fish_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> sensor_state
    <span class="token keyword">print</span><span class="token punctuation">(</span>flying_fish_state<span class="token punctuation">)</span>

</pre><p>Pour savoir quel Flying-Fish est associ&#xE9;e &#xE0; quel GPIO, veuillez <a href="####Fyling-Fish">lire la section en parlant dans la section des branchements</a>.</p>
<p>Lorsque l&apos;un des Flying-Fish change d&apos;&#xE9;tat et que son &#xE9;tat ne deviens pas &#xE0; <code>True</code>, la voiture coupe alors ses moteurs. Si le nouvel &#xE9;tat est <code>True</code>, cela veut dire que l&apos;on vient de d&#xE9;tecter du sol.</p>
<p>&#xC0; noter, que l&apos;utilisateur peut toujours faire avancer sa voiture lorsque l&apos;un des capteurs ne d&#xE9;tecte plus de sol, car si on arrive dans une configuration comme celle ci :</p>
<p><img src="./images/voiture/voiture_entre_deux_tables.jpg" alt="Voiture entre 2 tables" title="Voiture entre 2 tables"></p>
<p>Sachant qu&apos;il s&apos;agit de l&apos;utilisateur, il est conscient qu&apos;il peut toujours avancer, cependant je n&apos;ai pas laiss&#xE9; l&apos;utilisateur allez dans le sens du vide, car m&#xEA;me s&apos;il se peut qu l&apos;on arrive dans la quasi-m&#xEA;me configuration que vu dans l&apos;image du dessus, mais avec les deux roues entres les tables.</p>
<p>Je ne l&apos;ai pas laiss&#xE9; avancer dans le sens du vide, car dans la plupart du temps si la ligne de d&#xE9;tecteur ne d&#xE9;tecte plus de sol. C&apos;est qu&apos;il y a de fortes chances que nous puissions pas attendeindre l&apos;autre c&#xF4;t&#xE9; du vide et par cons&#xE9;quent faire tomber la voiture dans ce vide.</p>
<p>Mais dans le cas ou la voiture est au bord de table de justesse, l&apos;utilisateur peut tout de m&#xEA;me mettre les gaz &#xE0; fond. Ce qui est d&#xE9;conseill&#xE9;, car certes d&#xE8;s la non d&#xE9;tection du sol les moteurs se coupent mais &#xE0; cause de l&apos;inertie des roues, la voiture tombe dans le vide. Il est donc tr&#xE8;s important que dans ce genre de cas l&apos;utilisateur soit conscient de ce qu&apos;il fait.</p>
<p><img src="./images/voiture/voiture_bord_de_table_extreme.png" alt="Voiture au bord de table" title="Voiture au bord de table"></p>
<h4 class="mume-header" id="comment-fonctionne-le-mode-automatique-de-la-voiture">Comment fonctionne le mode automatique de la voiture ?</h4>

<p>Lorsque le lidar est actif et que le mode automatique a &#xE9;t&#xE9; activ&#xE9;e par la route <code>/launch_automatic_mode/&lt;int:state&gt;</code>, la m&#xE9;thode g&#xE9;rant la voiture va &#xEA;tre lanc&#xE9;e sur un autre thread diff&#xE9;rent de celui principal. &#xC0; la base, j&apos;avais tent&#xE9; d&apos;utiliser <code>Asyncio</code> une nouvelle fois pour ce cas mais j&apos;avais besoin de pouvoir changer l&apos;&#xE9;tat de le boucle pr&#xE9;sente dans <code>automatic_mode()</code>, car avec <code>Asyncio</code> lorsque je relan&#xE7;ais le mode automatique, il y avait des erreurs qui intervenaient tandis qu&apos;en ex&#xE9;cutant le programme sur un autre thread on peut relancer le mode avec l&apos;&#xE9;tat de la case &#xE0; cocher associ&#xE9;e.</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/launch_automatic_mode/&lt;int:state&gt;&quot;</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">launch_automatic_mode</span><span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Launch the automatic_mode on another thread&quot;&quot;&quot;</span>
    <span class="token keyword">global</span> automatic_mode_state
    automatic_mode_state <span class="token operator">=</span> state
    <span class="token comment"># Create the thread</span>
    thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>automatic_mode<span class="token punctuation">)</span>
    <span class="token comment"># Launch it</span>
    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>


<span class="token keyword">def</span> <span class="token function">automatic_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Execute the automatic mode&quot;&quot;&quot;</span>
    <span class="token keyword">global</span> car
    <span class="token keyword">global</span> rows
    <span class="token keyword">global</span> automatic_mode_state
    <span class="token keyword">global</span> obstacles_distances_front_left
    <span class="token keyword">global</span> obstacles_distances_front_right

    <span class="token keyword">while</span> automatic_mode_state <span class="token operator">==</span> constants<span class="token punctuation">.</span>MODE_ON<span class="token punctuation">:</span>
        <span class="token comment"># Used to store the obstacles detected at left and right</span>
        obstacles_distances_front_left <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        obstacles_distances_front_right <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            distance <span class="token operator">=</span> rows<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

            <span class="token keyword">if</span> car <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># Verify that the current angle is between 0 and 15, 345 and 360 </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>
                    i <span class="token operator">&lt;</span> constants<span class="token punctuation">.</span>MAX_ANGLE_OBSTACLE_DETECTION
                    <span class="token keyword">or</span> i <span class="token operator">&gt;</span> constants<span class="token punctuation">.</span>FULL_ANGLE <span class="token operator">-</span> constants<span class="token punctuation">.</span>MAX_ANGLE_OBSTACLE_DETECTION
                <span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token comment"># Verify if the distance is lower than the max front distance obstacle detection </span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>
                        distance <span class="token operator">&lt;</span> constants<span class="token punctuation">.</span>FRONT_DISTANCE_OBSTACLE_DETECTION
                        <span class="token keyword">and</span> distance <span class="token operator">&gt;</span> <span class="token number">0</span>
                    <span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token comment"># If the current angle is lower than the max angle</span>
                        <span class="token comment"># Add it into the left array</span>
                        <span class="token keyword">if</span> i <span class="token operator">&lt;</span> constants<span class="token punctuation">.</span>MAX_ANGLE_OBSTACLE_DETECTION<span class="token punctuation">:</span>
                            obstacles_distances_front_left<span class="token punctuation">.</span>append<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>
                        <span class="token comment"># If the current angle is greater than the max angle inverted (345 to 360)</span>
                        <span class="token comment"># Add it into the right array</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>
                            i
                            <span class="token operator">&gt;</span> constants<span class="token punctuation">.</span>FULL_ANGLE
                            <span class="token operator">-</span> constants<span class="token punctuation">.</span>MAX_ANGLE_OBSTACLE_DETECTION
                        <span class="token punctuation">)</span><span class="token punctuation">:</span>
                            obstacles_distances_front_right<span class="token punctuation">.</span>append<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>
                        <span class="token comment"># Compute the power, more the obstacle is near, more the motors will be powered</span>
                        speed <span class="token operator">=</span> distance <span class="token operator">/</span> constants<span class="token punctuation">.</span>FRONT_DISTANCE_OBSTACLE_DETECTION
                        <span class="token comment"># Goes backward</span>
                        car<span class="token punctuation">.</span>auto_move<span class="token punctuation">(</span>speed<span class="token punctuation">)</span>
                <span class="token comment"># Verify that the current angle is between 165 and 180, 180 and 195 </span>
                <span class="token keyword">elif</span> <span class="token punctuation">(</span>
                    i <span class="token operator">&lt;</span> constants<span class="token punctuation">.</span>HALF_ANGLE <span class="token operator">+</span> constants<span class="token punctuation">.</span>MAX_ANGLE_OBSTACLE_DETECTION
                    <span class="token keyword">or</span> i <span class="token operator">&gt;</span> constants<span class="token punctuation">.</span>HALF_ANGLE <span class="token operator">-</span> constants<span class="token punctuation">.</span>MAX_ANGLE_OBSTACLE_DETECTION
                <span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token comment"># Verify if the distance is lower than the max front distance obstacle detection </span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>
                        distance <span class="token operator">&lt;</span> constants<span class="token punctuation">.</span>BACK_DISTANCE_OBSTACLE_DETECTION
                        <span class="token keyword">and</span> distance <span class="token operator">&gt;</span> <span class="token number">0</span>
                    <span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token comment"># Compute the power, more the obstacle is near, more the motors will be powered</span>
                        speed <span class="token operator">=</span> distance <span class="token operator">/</span> constants<span class="token punctuation">.</span>BACK_DISTANCE_OBSTACLE_DETECTION
                        <span class="token comment"># Goes forward</span>
                        car<span class="token punctuation">.</span>auto_move<span class="token punctuation">(</span>speed <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token comment"># If nothing, reset the handlebar and stop the motors</span>
                    car<span class="token punctuation">.</span>stop_moving<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    car<span class="token punctuation">.</span>reset_handlebar<span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token comment"># Select the smallest element</span>
                lowest_dist_left <span class="token operator">=</span> constants<span class="token punctuation">.</span>FRONT_DISTANCE_OBSTACLE_DETECTION
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>obstacles_distances_front_left<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> lowest_dist_left <span class="token operator">&gt;</span> obstacles_distances_front_left<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
                        lowest_dist_left <span class="token operator">=</span> obstacles_distances_front_left<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

                
                <span class="token comment"># Select the smallest element</span>
                lowest_dist_right <span class="token operator">=</span> constants<span class="token punctuation">.</span>FRONT_DISTANCE_OBSTACLE_DETECTION
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>obstacles_distances_front_right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> lowest_dist_right <span class="token operator">&gt;</span> obstacles_distances_front_right<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
                        lowest_dist_right <span class="token operator">=</span> obstacles_distances_front_right<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                <span class="token comment"># Check that their values are not the default one</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>
                    lowest_dist_right <span class="token operator">!=</span> constants<span class="token punctuation">.</span>FRONT_DISTANCE_OBSTACLE_DETECTION
                    <span class="token keyword">and</span> lowest_dist_left <span class="token operator">!=</span> constants<span class="token punctuation">.</span>FRONT_DISTANCE_OBSTACLE_DETECTION
                <span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token comment"># If the nearest obstacle is at left, we need to turn to the right</span>
                    <span class="token keyword">if</span> lowest_dist_left <span class="token operator">&lt;</span> lowest_dist_right<span class="token punctuation">:</span>
                        car<span class="token punctuation">.</span>turn<span class="token punctuation">(</span>car<span class="token punctuation">.</span>MIN_ANGLE<span class="token punctuation">)</span>
                    <span class="token comment"># If the nearest obstacle is at right, we need to turn to the left</span>
                    <span class="token keyword">elif</span> lowest_dist_left <span class="token operator">&gt;</span> lowest_dist_right<span class="token punctuation">:</span>
                        car<span class="token punctuation">.</span>turn<span class="token punctuation">(</span>car<span class="token punctuation">.</span>MAX_ANGLE<span class="token punctuation">)</span>
                    <span class="token comment"># Else, just reset the handlebar</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        car<span class="token punctuation">.</span>reset_handlebar<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>Voici l&apos;algorithme r&#xE9;sum&#xE9; :</p>
<p><img src="./images/algorithm_auto_mode.png" alt="Algorithme du mode automatique" title="Algorithme du mode automatique"></p>
<h3 class="mume-header" id="raspberry-pi-0-wifi-1">Raspberry Pi 0 WiFi</h3>

<h4 class="mume-header" id="%C3%A0-quoi-servent-ils">&#xC0; quoi servent-ils ?</h4>

<p>Les raspberry pi 0 WiFi, sont utilis&#xE9;s pour g&#xE9;rer les cam&#xE9;ras et les phares.</p>
<h4 class="mume-header" id="comment-on-lutilise-1">Comment on l&apos;utilise ?</h4>

<p>Il faut lancer sur chaque raspberry pi 0 WiFi le serveur Flask avec la commande : <code>python3 ACKERMANNGUE-AG_Dipl_Tech_2021_VoitureAssistee/code/Flask/flask_sensors_control/server.py</code>.</p>
<h4 class="mume-header" id="comment-fonctionne-t-il-1">Comment fonctionne-t-il ?</h4>

<p>Le serveur Flask proprose 2 routes :</p>
<h5 class="mume-header" id="gestion-des-capteurs-%C3%A0-distance">Gestion des capteurs &#xE0; distance</h5>

<p>Pour g&#xE9;rer les capteurs &#xE0; distance, j&apos;utilise 2 serveurs Flask diff&#xE9;rents.</p>
<p>Le premier est le serveur principale tournant sur le Pi 4, celui sur lequel l&apos;utilisateur sera pour avoir acc&#xE8;s au tableau de bord, &#xE0; la t&#xE9;l&#xE9;commande pour la voiture.</p>
<p>Le second est le serveur tournant sur les Pi 0 WiFi, son r&#xF4;le est d&apos;effectuer des actions en fonction des diverses routes utilis&#xE9;es. Il y a 2 routes tr&#xE8;s importantes.</p>
<ol>
<li>
<p><code>@app.route(&apos;/streaming_camera&apos;)</code></p>
</li>
<li>
<p><code>@app.route(&apos;/&lt;string:sensor&gt;/&lt;int:state&gt;&apos;, methods=[&apos;POST&apos;, &apos;OPTIONS&apos;])</code></p>
</li>
<li>
<p>Le flux vid&#xE9;o de la cam&#xE9;ra</p>
</li>
<li>
<p>La gestion des modules cam&#xE9;ra et bright-pi</p>
</li>
</ol>
<p>La seconde est celle qui effectue les actions sur les capteurs, voici un exemple : <code>192.168.50.230:5000/camera/1</code>.</p>
<p>&#xC0; noter, il est important d&apos;utiliser <code>Flask-CORS</code> comme suit :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">from</span> flask_cors <span class="token keyword">import</span> CORS
<span class="token keyword">from</span> flask_cors<span class="token punctuation">.</span>decorator <span class="token keyword">import</span> cross_origin

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
cors <span class="token operator">=</span> CORS<span class="token punctuation">(</span>app<span class="token punctuation">,</span> withCredentials <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&apos;/&lt;string:sensor&gt;/&lt;int:state&gt;&apos;</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&apos;POST&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;OPTIONS&apos;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@cross_origin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">sensor_control</span><span class="token punctuation">(</span>sensor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</pre><p>Car vu que l&apos;on acc&#xE8;de &#xE0; cette route depuis une autre adresse IP, il est n&#xE9;cessaire d&apos;ajouter cette ligne <code>@cross_origin()</code> car elle permet de laisser l&apos;acc&#xE8;s &#xE0; cette route depuis un autre domaine. De plus, il est important d&apos;ajouter <code>&apos;OPTIONS&apos;</code> car lors de la premi&#xE8;re <em>lecture</em> de CORS, cette m&#xE9;thode sera utilis&#xE9;e en tant qu&apos;approbation de la part du serveur.</p>
<p>Dans la page du tableau de bord pour l&apos;utilisateur se trouve l&apos;appel AJAX qui va effectuer l&apos;action :</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">const</span> <span class="token constant">STATE_ON</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">STATE_OFF</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">CODE_FRONT</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CODE_RIGHT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CODE_BACK</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CODE_LEFT</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CODE_OTHER</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">SENSOR_CAMERA</span> <span class="token operator">=</span> <span class="token string">&quot;camera&quot;</span>
<span class="token keyword">const</span> <span class="token constant">SENSOR_LIDAR</span> <span class="token operator">=</span> <span class="token string">&quot;lidar&quot;</span>

<span class="token keyword">const</span> <span class="token constant">MODE_AUTOMATIC</span> <span class="token operator">=</span> <span class="token string">&quot;auto&quot;</span>

<span class="token keyword">const</span> <span class="token constant">IP_RSP_FRONT</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">IP_RSP_RIGHT</span> <span class="token operator">=</span> <span class="token number">114</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">IP_RSP_BACK</span> <span class="token operator">=</span> <span class="token number">172</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">IP_RSP_LEFT</span> <span class="token operator">=</span> <span class="token number">218</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">IP_RSP_MAIN</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">IP_NETWORK</span> <span class="token operator">=</span> <span class="token string">&quot;10.3.141.&quot;</span><span class="token punctuation">;</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#form_dashboard :checkbox&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">change</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> endpoint <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ip_address <span class="token operator">=</span> <span class="token constant">IP_NETWORK</span><span class="token punctuation">;</span>
        <span class="token comment">// get the value of the checkbok, it can be &quot;bright-pi&quot;, &quot;camera&quot; or &quot;flying-fish&quot;</span>
        <span class="token keyword">let</span> cbx_value <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// get the name of the checkbox</span>
        <span class="token keyword">let</span> cbx_name <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">attr</span><span class="token punctuation">(</span><span class="token string">&apos;name&apos;</span><span class="token punctuation">)</span>
        <span class="token comment">// get the last char of the checkbox&apos;s name in order to know which side needs to be changed</span>
        <span class="token comment">// example : cbxLight0, the 0 = the bright pi front sensors</span>
        <span class="token keyword">let</span> code_position <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>cbx_name<span class="token punctuation">.</span><span class="token method function property-access">substring</span><span class="token punctuation">(</span>cbx_name<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> cbx_name<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// reload the iframe of the selected camera</span>
        <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>cbx_value <span class="token operator">==</span> <span class="token constant">SENSOR_CAMERA</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">var</span> iframe <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cnvCam</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code_position<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>iframe<span class="token punctuation">.</span><span class="token property-access">src</span><span class="token punctuation">)</span>
            iframe<span class="token punctuation">.</span><span class="token property-access">src</span> <span class="token operator">=</span> iframe<span class="token punctuation">.</span><span class="token property-access">src</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// choose the correct ip for the raspberry </span>
        <span class="token keyword control-flow">switch</span> <span class="token punctuation">(</span>code_position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">CODE_FRONT</span><span class="token operator">:</span>
                ip_address<span class="token operator">+=</span><span class="token constant">IP_RSP_FRONT</span>
                <span class="token keyword control-flow">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">CODE_RIGHT</span><span class="token operator">:</span>
                ip_address<span class="token operator">+=</span><span class="token constant">IP_RSP_RIGHT</span>
                <span class="token keyword control-flow">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">CODE_BACK</span><span class="token operator">:</span>
                ip_address<span class="token operator">+=</span><span class="token constant">IP_RSP_BACK</span>
                <span class="token keyword control-flow">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">CODE_LEFT</span><span class="token operator">:</span>
                ip_address<span class="token operator">+=</span><span class="token constant">IP_RSP_LEFT</span>
                <span class="token keyword control-flow">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">CODE_OTHER</span><span class="token operator">:</span>
                ip_address<span class="token operator">+=</span><span class="token constant">IP_RSP_MAIN</span>
                <span class="token keyword control-flow">break</span><span class="token punctuation">;</span>
            <span class="token keyword module">default</span><span class="token operator">:</span>
                <span class="token keyword control-flow">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// verify the state of the checkbox</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">checked</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cbx_state <span class="token operator">=</span> <span class="token constant">STATE_ON</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
            cbx_state <span class="token operator">=</span> <span class="token constant">STATE_OFF</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// add the Flask port</span>
        ip_address <span class="token operator">+=</span> <span class="token string">&quot;:5000&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// set the URL</span>
        endpoint <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ip_address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cbx_value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cbx_state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>cbx_value <span class="token operator">==</span> <span class="token constant">SENSOR_LIDAR</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            endpoint <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/bg_processing_lidar/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cbx_state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#lidar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">attr</span><span class="token punctuation">(</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/video_feed/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cbx_state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>cbx_value <span class="token operator">==</span> <span class="token constant">MODE_AUTOMATIC</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            endpoint <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/launch_automatic_mode/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cbx_state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">execute</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">endpoint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token method function property-access">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token operator">:</span> endpoint<span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

</pre><h5 class="mume-header" id="r%C3%A9cup%C3%A9ration-du-flux-vid%C3%A9o">R&#xE9;cup&#xE9;ration du flux vid&#xE9;o</h5>

<p>La m&#xE9;thode que j&apos;utilise pour r&#xE9;cup&#xE9;rer le flux vid&#xE9;o de la cam&#xE9;ra avec un serveur Flask est tir&#xE9; de <a href="https://github.com/EbenKouao/pi-camera-stream-flask">ce github</a>.</p>
<p>Cette m&#xE9;thode se construit comme suit :</p>
<p><img src="./images/camera/algorithme_recuperation_stream_camera.png" alt="Cam&#xE9;ra et radar activ&#xE9;" title="Cam&#xE9;ra et radar activ&#xE9;"></p>
<p>Voici le code utilis&#xE9; dans le fichier <code>server.py</code> pr&#xE9;sent dans le r&#xE9;pertoire <code>\code\Flask\flask_sensors_control</code> :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&apos;/streaming_camera&apos;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">cam_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> camera_state
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">&apos;index.html&apos;</span><span class="token punctuation">,</span> name<span class="token operator">=</span>constants<span class="token punctuation">.</span>FRONT_CAM<span class="token punctuation">,</span> mode<span class="token operator">=</span>camera_state<span class="token punctuation">,</span> on<span class="token operator">=</span>constants<span class="token punctuation">.</span>STATE_ON<span class="token punctuation">,</span> off<span class="token operator">=</span>constants<span class="token punctuation">.</span>STATE_OFF<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gen</span><span class="token punctuation">(</span>camera<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#get camera frame</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        frame <span class="token operator">=</span> camera<span class="token punctuation">.</span>get_frame<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">b&apos;--frame\r\n&apos;</span>
               <span class="token string">b&apos;Content-Type: image/jpeg\r\n\r\n&apos;</span> <span class="token operator">+</span> frame <span class="token operator">+</span> <span class="token string">b&apos;\r\n\r\n&apos;</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&apos;/video_feed&apos;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">video_feed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> pi_camera
    <span class="token keyword">return</span> Response<span class="token punctuation">(</span>gen<span class="token punctuation">(</span>pi_camera<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mimetype<span class="token operator">=</span><span class="token string">&apos;multipart/x-mixed-replace; boundary=frame&apos;</span><span class="token punctuation">)</span>

</pre><p>&#xC0; noter, le code pour la cam&#xE9;ra a &#xE9;t&#xE9; repris du GitHub, mais dans mon cas il a &#xE9;t&#xE9; important de le modifier car &#xE0; la base la cam&#xE9;ra avait comme nombre de frame par seconde &#xE0; 30 ainsi qu&apos;une qualit&#xE9; d&apos;image de 480p ce que j&apos;ai chang&#xE9; &#xE0; la moiti&#xE9; afin d&apos;&#xE9;viter de surcharger le processeur du Raspberry Pi 4 :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">from</span> libs<span class="token punctuation">.</span>pivideostream <span class="token keyword">import</span> PiVideoStream
<span class="token keyword">import</span> imutils
<span class="token keyword">import</span> time
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">class</span> <span class="token class-name">VideoCamera</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flip <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> fps<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> res<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">320</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;cam init&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>vs <span class="token operator">=</span> PiVideoStream<span class="token punctuation">(</span>resolution<span class="token operator">=</span>res<span class="token punctuation">,</span> framerate<span class="token operator">=</span>fps<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>vs <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;cam init done&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>flip <span class="token operator">=</span> flip
        

    <span class="token keyword">def</span> <span class="token function">__del__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;cam del&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>vs<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">flip_if_needed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>flip<span class="token punctuation">:</span>
            <span class="token keyword">return</span> np<span class="token punctuation">.</span>flip<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> frame

    <span class="token keyword">def</span> <span class="token function">get_frame</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        frame <span class="token operator">=</span> self<span class="token punctuation">.</span>flip_if_needed<span class="token punctuation">(</span>self<span class="token punctuation">.</span>vs<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ret<span class="token punctuation">,</span> jpg <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imencode<span class="token punctuation">(</span><span class="token string">&apos;.jpg&apos;</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
        <span class="token keyword">return</span> jpg<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>Voici le code <code>HTML</code> utilis&#xE9; pour faire l&apos;affichage de l&apos;image :</p>
<pre data-role="codeBlock" data-info="HTML" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>newpost<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {% if mode == on %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>camera-bg<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token unit">%</span><span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token unit">%</span><span class="token punctuation">;</span> <span class="token property">background-attachment</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{{ url_for(<span class="token punctuation">&apos;</span>video_feed<span class="token punctuation">&apos;</span>) }}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {% elif mode == off %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>camera-bg<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token unit">%</span><span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token unit">%</span><span class="token punctuation">;</span> <span class="token property">background-attachment</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../static/img/camera_down.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {% endif %}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</pre><p>Cette image va donc &#xEA;tre modifi&#xE9;e &#xE0; chaque frame re&#xE7;ue par la cam&#xE9;ra.</p>
<h1 class="mume-header" id="dates-importantes">Dates importantes</h1>

<ul>
<li>Lundi 19 avril 2021 : D&#xE9;but du travail de dipl&#xF4;me</li>
<li>Vendredi 30 avril 2021 : &#xC9;valuation interm&#xE9;diaire 1</li>
<li>Vendredi 14 mai 2021 : Rendu du rapport interm&#xE9;diaire + poster</li>
<li>Vendredi 14 mai 2021 : Rendu version interm&#xE9;diaire du r&#xE9;sum&#xE9; et de l&#x2019;abstract (pour conseils par l&#x2019;enseignant d&#x2019;anglais)<br>
Lundi 17 mai 2021 : &#xC9;valuation interm&#xE9;diaire 2</li>
<li>Jeudi 20 mai 2021 apr&#xE8;s-midi : Soir&#xE9;e poster : amis, famille, CFC, experts
<ul>
<li>14h00 : Visite des classes de 1re ann&#xE9;e (cf. SG)</li>
<li>16h30 : Amis, famille, experts, enseignants Tech ES&#x2026;</li>
<li>18h00 : Fin de la soir&#xE9;e poster</li>
</ul>
</li>
<li>Lundi 31 mai 2021 : &#xC9;valuation interm&#xE9;diaire 3</li>
<li>Vendredi 11 juin 2021 : Rendu du travail avant 12h00</li>
<li>Jeudi 17 juin 2021 : D&#xE9;fenses &#xE0; blanc + harmonisation des notes</li>
<li>Lundi 21 juin ou mardi 22 juin 2021 : D&#xE9;fenses de dipl&#xF4;me</li>
</ul>
<h1 class="mume-header" id="retour-dexp%C3%A9rience">Retour d&apos;exp&#xE9;rience</h1>

<h2 class="mume-header" id="probl%C3%A8mes-rencontr%C3%A9s">Probl&#xE8;mes rencontr&#xE9;s</h2>

<h2 class="mume-header" id="r%C3%A9sultat">R&#xE9;sultat</h2>

<h2 class="mume-header" id="ce-quil-reste-%C3%A0-faire">Ce qu&apos;il reste &#xE0; faire</h2>

<h2 class="mume-header" id="am%C3%A9liorations-possibles">Am&#xE9;liorations possibles</h2>

<h2 class="mume-header" id="bilan-personnel">Bilan personnel</h2>

<h2 class="mume-header" id="apports-personnels">Apports personnels</h2>

<h1 class="mume-header" id="conclusion">Conclusion</h1>

<h1 class="mume-header" id="journal-de-bord">Journal de bord</h1>

<h1 class="mume-header" id="glossaire">Glossaire</h1>

<h1 class="mume-header" id="code-source">Code source</h1>


      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>